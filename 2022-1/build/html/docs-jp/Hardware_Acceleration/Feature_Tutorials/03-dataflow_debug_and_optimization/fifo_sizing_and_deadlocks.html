<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /><!-- OneTrust Cookies Consent Notice start for xilinx.github.io --><script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script><!-- OneTrust Cookies Consent Notice end for xilinx.github.io --><title>パフォーマンス用の FIFO のサイズ変更とデッドロックの回避 - Vitis™ チュートリアル 2022.1 の資料</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/_static/custom.css" type="text/css" /><!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]--><script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"><a href="../../../../index.html" class="icon icon-home">Vitis™ チュートリアル <img src="../../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/> </a><div class="version">2022.1</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">English</span></p><ul><li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs/index.html">Main</a></li></ul><p class="caption" role="heading"><span class="caption-text">入門</span></p><ul><li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis-Getting-Started.html">概要</a></li></ul><p class="caption" role="heading"><span class="caption-text">アクセラレーション</span></p><ul><li class="toctree-l1"><a class="reference internal" href="../../Hardware-Acceleration.html">ハードウェア アクセラレーション</a></li></ul><p class="caption" role="heading"><span class="caption-text">AI エンジン</span></p><ul><li class="toctree-l1"><a class="reference internal" href="../../../AI_Engine_Development/AI_Engine_Development.html">AI エンジン開発</a></li></ul><p class="caption" role="heading"><span class="caption-text">プラットフォーム</span></p><ul><li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Vitis_Platform_Creation.html">Vitis プラットフォームの作成</a></li></ul><p class="caption" role="heading"><span class="caption-text">その他のバージョン</span></p><ul><li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2021-2/build/html/index.html">2021.2</a></li><li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2021-1/build/html/index.html">2021.1</a></li><li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-2/docs/build/html/index.html">2020.2</a></li><li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/build/html/indexE.html">2020.1</a></li></ul></div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" ><i data-toggle="wy-nav-top" class="fa fa-bars"></i> <a href="../../../../index.html">Vitis™ チュートリアル</a></nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation"><ul class="wy-breadcrumbs"><li><a href="../../../../index.html" class="icon icon-home"></a>&raquo;</li> <li>パフォーマンス用の FIFO のサイズ変更とデッドロックの回避</li><li class="wy-breadcrumbs-aside"><a href="../../../../_sources/docs/Hardware_Acceleration/Feature_Tutorials/03-dataflow_debug_and_optimization/fifo_sizing_and_deadlocks.md.txt" rel="nofollow">ページ ソースの表示</a></li></ul><hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table width="100%">
 <tr width="100%">
    <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>ハードウェア アクセラレーション チュートリアル</h1><a href="https://japan.xilinx.com/products/design-tools/vitis.html">xilinx.com の Vitis™ 開発環境を参照</a></td>
 </tr>
</table><div class="section" id="fifo-sizing-for-performance-and-avoiding-deadlocks">
<h1>パフォーマンス用の FIFO のサイズ変更とデッドロックの回避<a class="headerlink" href="#fifo-sizing-for-performance-and-avoiding-deadlocks" title="Permalink to this heading">¶</a></h1>
<p>データフロー最適化はダイナミックな性質であり、並列タスクがそれぞれ異なる速度で実行される傾向があるので、データフロー チャネルのサイズが不適切だと、パフォーマンス低下やデッドロックの原因となる可能性があります。データフロー チャネルには、ユーザーが作成するものと、ツールが作成するものとがあります。</p>
<div class="section" id="types-of-channels">
<h2>チャネルのタイプ<a class="headerlink" href="#types-of-channels" title="Permalink to this heading">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">チャネル タイプ</th>
<th align="left">例</th>
<th align="center">作成者</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">FIFO</td>
<td align="left">ストリーム (hls::streams およびストリーム済みの配列配列)</td>
<td align="center">ユーザー</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">スカラー伝搬 FIFO</td>
<td align="center">ツール</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">ブロックのストリーム</td>
<td align="center">ユーザー</td>
</tr>
</tbody>
</table><p>これらの FIFO チャネルは、次の理由から、「独自のハンドシェイクを持つチャネル」だと考えられるべきです。</p><ul class="simple"> <li><p>読み出しおよび書き込み操作がスケジュールされている。</p></li> <li><p>読み出し/書き込み信号は、パイプライン制御または FSM により個々に駆動される。</p></li> <li><p>full_n/empty_n 信号は、パイプライン制御の繰り返し実行、または FSM のステートを個別に直接ストールさせる。</p></li> </ul>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">チャネル タイプ</th>
<th>例</th>
<th align="center">作成者</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">PIPO</td>
<td>PIPO</td>
<td align="center">ユーザー</td>
</tr>
<tr>
<td align="center"></td>
<td>タスク レベルの FIFO (TLF)</td>
<td align="center">ツール</td>
</tr>
<tr>
<td align="center"></td>
<td>上位への入力および出力ポート</td>
<td align="center">ユーザー</td>
</tr>
</tbody>
</table><p>タスク レベルの FIFO (TLF) はスカラー FIFO で、書き込み用にプロデューサーの done ハンドシェイクに、読み出し用にコンシューマーの start ハンドシェイクに接続されています。これらのタイプの FIFO はツールにより自動的に推論されます。基本になる同期化メカニズムが理由で、これらは PIPO のような FIFO だと考えられています。</p>
<p>これらのチャネルは、次の理由から、「ap_ctrl_chain を使用するチャネル」だと考えられるべきです。</p><ul class="simple"> <li><p>書き込みおよび読み出し操作はスケジュールされていない。これらのチャネルは、プロセスの done ハンドシェイクまたは start ハンドシェイクに黙示的に関連付けられている。</p></li> <li><p>書き込みおよび読み出し信号は、ap_done および ap_ready にそれぞれ接続されている。</p></li> <li><p>書き込およびと読み出し信号は、ap_continue および ap_start にそれぞれ接続されている。</p></li> </ul>
<p>深さ、パフォーマンス、デッドロックなどの解析は、次の要因に左右されます。</p><ul class="simple"> <li><p>チャネルに独自のハンドシェイクがある (FIFO)。したがって、そのプロセスが実行されている時間全体に均等にアクセスが分散されている。<em></em>たとえば、パイプラインの最初の開始間隔 (II) 外で、またはデータフロー ネットワークの最後のプロセスであっても、FIFO を読み出すことが可能。</p></li> <li><p>チャネルは ap_ctrl_chain を介してハンドシェイクされる (PIPO)。したがって、読み出しは、パイプラインの開始間隔 (II) か、またはデータフロー ネットワークの最初の「レベル」にあるプロセスで実行する必要がある。同様に、書き込みは最終の II か、最終の「レベル」で実行する必要がある。</p></li> <li><p>1 操作で転送されるデータ量に基づいて違いがある。この違いは、フォーマンスよりも、PIPO の配列、ブロックのストリーム、ストリームのスカラー、スカラー伝搬 FIFO およびタスク レベル FIFO のリソース解析に関連している。</p></li> </ul>
</div>
<div class="section" id="deadlock-detection-and-analysis">
<h2>デッドロック検出と解析<a class="headerlink" href="#deadlock-detection-and-analysis" title="Permalink to this heading">¶</a></h2>
<p>データフローで FIFO のサイズが不十分に設定されていると、デッドロックが起きる可能性があります。次の図を参照してください。<img alt="Dataflow FIFO Channels" src="../../../../_images/dataflow_fifo_channels.png" /></p><ul class="simple"> <li><p>ケース 1</p><ul> <li><p>プロデューサーは、FIFO1、FIFO2、FIFO1、FIFO2 と交互に書き込みを実行します。</p></li> <li><p>コンシューマーは、FIFO1、FIFO2、FIFO1、FIFO2 と交互に読み出しを実行します。</p></li> <li><p>両方の FIFO の深さが 1 であれば、デッドロックを回避するのに十分です (デフォルトの深さ 2 がパフォーマンスには最適です)。</p></li> </ul>
</li>
<li><p>ケース 2 (同じ構造)</p><ul> <li><p>プロデューサーは、FIFO1 へ N 回、次に FIFO2 へ N 回、書き込みを実行します。</p></li> <li><p>コンシューマーは、FIFO1、FIFO2、FIFO1、FIFO2 と交互に読み出しを実行します。</p></li> <li><p>FIFO1 には、深さ N が必要です (FIFO2 には、デフォルト値である深さ 2 がパフォーマンスには最適です)。</p></li> </ul>
</li>
</ul>
<p>上記の 2 つの単純なケースからわかるように、まったく同じ構造のコードでも、FIFO チャネルへのアクセスのしかたによって、FIFO の深さを異なる値に設定する必要がある場合があります。<em></em>FIFO の深さは、FIFO アクセスのバースト ビヘイビアーをならし、一致させるのに使用されます。</p>
<p>(プロセス間のスカラーまたは配列から) コンパイラで生成された FIFO および PIPO は決してデッドロックを引き起こしません。ただし、最適なパフォーマンスを得るのに十分な深さではない可能性があります。(プロセス間の hls::streams と hls::stream_of_blocks から) ユーザーが作成した FIFO は、深さ設定によっては、デッドロックと低いパフォーマンスを引き起こす可能性があります。</p>
<blockquote>
<div><p><strong>ヒント:</strong> FIFO の深さが足りないことが原因でデッドロックが発生すると、常に、少なくとも 1 つの書き込み操作がブロックされています。そうでないとしたら、それはデザインの問題である可能性が高く、ノンブロッキングの読み出しまたは書き込み、または、empty() と full() によって条件が付けられている読み出しおよび書き込みが原因であることが一般的です。</p>
</div></blockquote>
<p>このチュートリアルは、データフロー デザインを解析し、ボトルネックになっている箇所を見つけやすくすることを目的にしています。ボトルネックが起きやすいのは次のところです。</p>
<ol class="simple"><li><p>開始間隔 (II) がほかの箇所と比べて長く、全体的なスループットを制限する可能性のあるプロセスまたは領域。この問題は、次の方法で修正できます。</p><ul class="simple"> <li><p>開始間隔 (II) を短くする。</p></li> <li><p>データフロー領域を調べ、その領域内に何らかの理由がないか精査する (その理由は、ここに挙げている 3 つのどれか 1 つである可能性がある)。</p></li> </ul>
</li>
<li><p>深さの値が小さすぎるため、いっぱいになる可能性がある、FIFO (独自のハンドシェイクを持つチャネルで、ストリーム、ブロックのストリーム、ストリーム済みの列を含む) または PIPO (独自のハンドシェイクを持たないチャネルで、PIPO と TLF を含む)。この問題は、チャネルの深さの値を大きくすることで解決できます。次のセクションで、この方法を説明します。</p></li> <li><p>最上位の同期 (上位からのスカラー入力か、外部メモリ入力、または呼び出しコンテキストへの出力、領域の ap_ctrl_chain または ap_ctrl_hs を介して同期されます)。この場合、パフォーマンスの低下を回避するため、これらの変数を手動でコピーし、プロセスのネットワークに渡すと問題を解決できます。</p></li></ol>
<p>データ依存の同期を使用した複雑なデザインの場合 (たとえば、1 回の実行で、あるプロセスで FIFO から 128 回読み込み、別のプロセスでは 32 回読み込む)、プロセスがブロックする可能性があり、その理由もさまざまで、時間と共に変わっていく点に注意してください。この場合、先のラボで説明したように、データフローの協調シミュレーションの波形のみが、デバッグの有効なアプローチとなる可能性があります。</p>
<p>このチュートリアルでは次に、サンプル デザインを合成してから、Dataflow Viewer を表示し、デッドロックを調べて解決する方法を紹介します。この演習では、<code class="docutils literal notranslate"><span class="pre">reference-files/deadlock</span></code> フォルダーにある単純な<a class="reference external" href="./reference-files/src/deadlock/example.cpp">デッドロック例</a>を見てみます。</p>
<p>この演習では、次を点を学びます。</p>
<ol class="simple"><li><p>Dataflow Viewer のさまざまな機能を使って、デッドロックを調べる方法を理解します。</p></li> <li><p>FIFO サイズ変更機能を使用し、デッドロックを解消し、パフォーマンスを向上させます。</p></li></ol>
</div>
<div class="section" id="second-lab">
<h2>第 2 回演習<a class="headerlink" href="#second-lab" title="Permalink to this heading">¶</a></h2>
<ol class="simple"><li><p><code class="docutils literal notranslate"><span class="pre">03-dataflow_debug_and_optimization/reference-files/deadlock</span></code> ディレクトリに移動し、次のコマンドを実行して Vitis HLS のツールを起動します。</p></li></ol>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span></pre></div>
</div>
<p>Vitis HLS GUI が起動して、デザインを合成するために必要なプロジェクトを作成しますが、GUI は <code class="docutils literal notranslate"><span class="pre">script.tcl</span></code> ファイル内のコマンドを実行する手前で停止します。</p><ul class="simple"> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の横にあるドロップダウン リストをクリックし、<code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span></code> (次の図を参照) を選択して、<code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span> <span class="pre">Dialog</span></code> ボックスで <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックし、シミュレーションを実行します。</p></li> </ul>
<p><img alt="C Simulation" src="../../../../_images/c_sim.png" /></p><ul class="simple"> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) をクリックして、デザインを合成します。</p></li> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の横にあるドロップダウン リストをクリックし、<code class="docutils literal notranslate"><span class="pre">Co-simulation</span></code> リンクをクリックしてから、<code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> オプションを選択し、ポップアップ表示されたウィンドウで <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックして C/RTL コシミュレーションを実行します。このデザインでデッドロックが検出されると、GUI は自動的に Dataflow Viewer を起動します (次の図を参照)。</p></li> </ul>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/dataflow_deadlock_view.png" /></p><ul class="simple"> <li><p>Dataflow Graph のツールバー メニューにある緑色の <code class="docutils literal notranslate"><span class="pre">+</span></code> コマンドをクリックし、デザインのすべてのチャネルおよび下位プロセスを展開します。デッドロックが発生したプロセスは、グラフの中で赤く表示されます (次の図を参照)。いっぱいのチャネルはグラフ内に赤い矢印で表示され、空のチャネルはグラフ内に白い矢印で表示されます。[Channel] 表ではさらに、いっぱいまたは空のチャネルの深さが赤でハイライトされます。</p></li> <li><p><code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> 列と <code class="docutils literal notranslate"><span class="pre">Depth</span></code> 列の両方を使用すると、サイズ変更の必要がある最初のチャネルは <strong>data_channel1</strong> であることがわかります。このチャネルは、プロデューサー <strong>proc_1_1_U0</strong> と、コンシューマー <strong>proc_1_2_U0</strong> プロセスの間にあります (<code class="docutils literal notranslate"><span class="pre">Producer</span></code> と <code class="docutils literal notranslate"><span class="pre">Consumer</span></code> の列に表示されています)。</p></li> </ul>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/dataflow_deadlock_view2.png" /></p>
<p>この FIFO サイズを変更するには 3 つの方法があり、この演習ではそれぞれを順番に説明します。</p><ul class="simple"> <li><p>手動の FIFO サイズ変更</p></li> <li><p>グローバルな FIFO サイズ変更</p></li> <li><p>自動の FIFO サイズ変更</p></li> </ul>
<div class="section" id="manual-fifo-sizing">
<h3>手動の FIFO サイズ変更<a class="headerlink" href="#manual-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>FIFO や PIPO の深さが十分でないことによるパフォーマンス低下は、常に少なくとも 1 つのプロセスが、いっぱいの FIFO でブロックされる原因となります。普通、FIFO の深さの適切な値を決めることはできません。幸いなことに、RTL 協調シミュレーションでは、各チャネルで達成された深さの最大値もレポートされるので、FIFO の深さを任意の大きな値を割り当てておいたとしても、シミュレーションで達成できた最大値にいつでも変更できます。また、FIFO や PIPO の深さを増やしてもパフォーマンスが低下することはなく、単に追加リソースが消費されるだけです。</p>
<p><img alt="Adjusting FIFO Depth 1." src="../../../../_images/adjusting_fifo_depth.png" /></p>
<p>説明したように、プロデューサー <strong>proc_1_1_U0</strong> とコンシューマー <strong>proc_1_2_U0</strong> プロセスの間にある <strong>data_channel1</strong> のサイズを変更する必要があります。ブロックされた FIFO のサイズを変更するには、次の手順に従います。</p><ul class="simple"> <li><p>上の図のように、ハイライトされた <strong>data_channel1</strong> の行を右クリックし、<code class="docutils literal notranslate"><span class="pre">Modify</span> <span class="pre">Depth</span></code> オプションを選択します。次のような <strong>[Modify Depth]</strong> ダイアログ ボックスが開きます。</p></li> </ul>
<p><img alt="Modifying FIFO Depth" src="../../../../_images/modify_depth.png" /></p><ul class="simple"> <li><p>新しい深さを 4 (2 の倍) に設定し、<code class="docutils literal notranslate"><span class="pre">OK</span></code> ボタンをクリックします。</p></li> <li><p>GUI に、協調シミュレーションを再実行する必要があるかどうかをたずねるメッセージが表示されます。FIFO の深さの値を変更し終わっていないので、<code class="docutils literal notranslate"><span class="pre">No</span></code> をクリックします。</p></li> <li><p>デッドロックの原因となっている <strong>data_channel2</strong> についても同じ作業を繰り返します。</p></li> <li><p>GUI に、協調シミュレーションを再実行する必要があるかどうかをたずねるメッセージが表示されます。<code class="docutils literal notranslate"><span class="pre">Yes</span></code> をクリックし、<code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> オプションを選択してから <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックし、協調シミュレーションを開始します。</p></li> <li><p>C/RTL 協調シミュレーションが再度実行され、デザインがまだデッドロックしていることがレポートされます (次の図を参照)。</p></li> </ul>
<p><img alt="Adjusting FIFO Depth 2." src="../../../../_images/adjusting_fifo_depth2.png" /></p><ul class="simple"> <li><p>次に上記の手順を繰り返し、<strong>data_channel1</strong> と <strong>data_channel2</strong> の深さを 10 に変更します。C/RTL 協調シミュレーションを再実行し、デッドロックがこれらのチャネルではなく、プロセス <strong>proc_1_U0</strong> と <strong>proc_2_U0</strong> の間のチャネルに移動していることを確認します (次の図を参照)。</p></li> </ul>
<p><img alt="Adjusting FIFO Depth 3." src="../../../../_images/adjusting_fifo_depth3.png" /></p><ul class="simple"> <li><p>これらのチャネルに対し、FIFO のサイズ変更手順を繰り返し、深さを 10 に設定してから、C/RTL 協調シミュレーションを再実行します。デッドロックがプロセス <strong>proc_2_1_U0</strong> と <strong>proc_2_2_U0</strong> の間のチャネルに移動したことに注意してください (次の図を参照)。</p></li> </ul>
<p><img alt="Adjusting FIFO Depth 4." src="../../../../_images/adjusting_fifo_depth4.png" /></p><ul class="simple"> <li><p>これらのチャネルに対し、FIFO のサイズ変更手順を繰り返し、深さを 10 に設定してから、C/RTL 協調シミュレーションを再実行します。デッドロックが解消されたことに注目してください (次の図を参照)。</p></li> </ul>
<p><strong>ヒント:</strong> デッドロックの問題が解決されたため、Dataflow Graph が自動的に表示されない可能性があります。Dataflow Graph ビューアーを手動で開く必要がある場合があります。</p>
<p><img alt="Adjusting FIFO Depth 5." src="../../../../_images/adjusting_fifo_depth5.png" /></p>
<p>上の図では、実際に深さ 10 を必要とするチャネルは 3 つのみである点に注意してください。これは、<code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> と <code class="docutils literal notranslate"><span class="pre">Depth</span></code> の列を比較すると確認できます。その他のチャネルはデフォルトの深さで問題なく、深さの値を大きくする必要はありません。</p>
<p><strong>重要:</strong> デッドロックは解決されましたが、問題解決のために設定した新しい FIFO の深さは、ソース コードにバックアノテートされていません。ここで Vitis HLS GUI を終了すると、この設定は失われます。ソース コードに新しい深さの値をバックアノテートすることにした場合は、このチュートリアルの次の段階に進むときに、あとで元に戻す必要があるので注意してください。</p><ul class="simple"> <li><p>ソース コードにソリューションをバックアノテートするには、新しい深さの値が必要なチャネルをすべて選択し (Ctrl キーを押しながらマウスでチャネルを選択)、次の図のように <code class="docutils literal notranslate"><span class="pre">Back</span> <span class="pre">Annotate</span> <span class="pre">the</span> <span class="pre">New</span> <span class="pre">Depth</span> <span class="pre">into</span> <span class="pre">the</span> <span class="pre">Design</span></code> オプションを選択し、<code class="docutils literal notranslate"><span class="pre">Next</span></code> をクリックします。</p></li> </ul>
<p><img alt="Back Annotate" src="../../../../_images/back_annotate.png" /> <img alt="Back Annotate" src="../../../../_images/back_annotate0.png" /></p><ul class="simple"> <li><p>新しいウィンドウが開き、デザインのソース コードに挿入されるプラグマという形で変更内容が表示されます。この新しいプラグマ設定には、このプラグマが Vitis HLS によって挿入されたことを示すコメントが含まれる点に注意してください (次の図を参照)。</p></li> </ul>
<p><img alt="Back Annotate" src="../../../../_images/back_annotate1.png" /></p>
<p>バックアノテートの各ステップのあと、GUI にデザインを再合成するかどうかを尋ねるメッセージが表示されます (新しいプラグマが追加されたため)。<code class="docutils literal notranslate"><span class="pre">Yes</span></code> をクリックしてデザインを再合成します。次に、緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の横にあるドロップダウン リストをクリックし、<code class="docutils literal notranslate"><span class="pre">Co-simulation</span></code> リンクをクリックし、<code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> オプションを選択してから、ポップアップ表示されるウィンドウで <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックして C/RTL 協調シミュレーションを実行します。新しいプラグマ設定でデッドロックが解決されていることを確認します。</p>
<p><strong>重要:</strong> チュートリアルの次のステップに進む前に、上記のアノテーションのステップを必ず元に戻してください。<code class="docutils literal notranslate"><span class="pre">Explorer</span></code> タブで <code class="docutils literal notranslate"><span class="pre">example.cpp</span></code> をダブルクリックし (下図)、右端にある <code class="docutils literal notranslate"><span class="pre">Directives</span></code> タブを選択します。このタブに、最後のステップで追加された新しいプラグマが表示されます。各プラグマを右クリックし、<code class="docutils literal notranslate"><span class="pre">Remove</span> <span class="pre">Directive</span></code> を選択すると、ソース ファイルから削除されます。</p>
<p><img alt="Back Annotate" src="../../../../_images/remove_directive.png" /></p>
</div>
<div class="section" id="global-fifo-sizing">
<h3>グローバルな FIFO サイズ変更<a class="headerlink" href="#global-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>Global FIFO サイズ変更フローを使用するには、最初からやり直す必要があります。Vitis HLS GUI を終了し、コマンド ラインで次を実行し、再起動します。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span></pre></div>
</div>
<p>次の手順に従ってください。</p>
<ol class="simple"><li><p>緑色の [Run] アイコン (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の横にあるドロップダウンの矢印をクリックし、<code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span></code> を選択して表示されるウィンドウで <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックします。</p></li> <li><p>csim が警告メッセージを出さずに正常に終了していることを確認します。</p><ul class="simple"> <li><p>C シミュレータがコンソールに出力する hls::stream の深さの最大値を確認し、書きとめます。</p></li> </ul>
</li>
</ol>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">reached</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="n">hls</span><span class="o">::</span><span class="n">stream</span><span class="p">()</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">design</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">40</span><span class="w"></span></pre></div>
</div>
<ol><li><p>すべての FIFO の深さが、C シミュレーションによってレポートされた最大値になるように設定します。トップ メニューの <code class="docutils literal notranslate"><span class="pre">Solution</span></code> リンクをクリックし、<code class="docutils literal notranslate"><span class="pre">Solution</span> <span class="pre">Settings</span></code> を選択すると、深さの最大値を設定できます (次の図を参照)。</p>
<p><img alt="Solution Settings" src="../../../../_images/solution_settings.png" /></p></li> <li><p><code class="docutils literal notranslate"><span class="pre">Solution</span> <span class="pre">Settings</span></code> ウィンドウの <code class="docutils literal notranslate"><span class="pre">General</span></code> で、[Configuration Settings] で <code class="docutils literal notranslate"><span class="pre">config_dataflow</span></code> までスクロールし (次の図)、<code class="docutils literal notranslate"><span class="pre">override_user_fifo_depth</span></code> の値を 40 に設定します。<code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックして、この新しいコンフィギュレーションを設定します。</p>
<p><img alt="Global Settings" src="../../../../_images/global_setting1.png" /></p></li> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) をクリックして、C 合成を再実行します。</p></li> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の隣にあるドロップダウン リストから <code class="docutils literal notranslate"><span class="pre">Co-Simulation</span></code> を選択し、C/RTL 協調シミュレーションを再実行します。表示されるウィンドウで <code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックします。</p></li> <li><p>今回はデッドロックは発生せず、C/RTL 協調シミュレーションはエラーもなく終了します。</p></li> <li><p><code class="docutils literal notranslate"><span class="pre">Co-simulation</span> <span class="pre">Report</span></code> に移動し、[Daraflow] アイコンの横にある一番上の関数を右クリックし、<code class="docutils literal notranslate"><span class="pre">Open</span> <span class="pre">Dataflow</span> <span class="pre">Viewer</span></code> を選択して Dataflow Viewer を再起動してください。</p></li> <li><p>次に、Dataflow Viewer の [Channel] 表で、<code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> と <code class="docutils literal notranslate"><span class="pre">Depth</span></code> の列の深さを比較します。正しい深さは、<code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> の列で確認できます (次の図を参照)。これは、このデザインのすべての FIFO に必要な深さです。</p>
<p><img alt="Global Settings" src="../../../../_images/global_setting.png" /></p></li> <li><p>これで、確認した <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> をソース コードのプラグマ設定として手動でバックアノテートできるようになりました。</p></li></ol>
</div>
<div class="section" id="automated-fifo-sizing">
<h3>自動の FIFO サイズ変更<a class="headerlink" href="#automated-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>3 つのアプローチのうち、自動 FIFO サイズ変更が最も簡単です。ただし:</p><ul class="simple"> <li><p>協調シミュレーションを繰り返し実行する必要があるため、収束までに時間がかかる場合があります。</p></li> <li><p>発見的アルゴリズムなので、場合によっては収束しないこともあります。</p></li> </ul>
<p>このアルゴリズムは、パフォーマンスが向上しなくなるまで、書き込みをブロックする FIFO の深さを自動的に増やします。一部の FIFO の深さを妥当な範囲を超えて増加させる可能性があるのでユーザーの確認が必要です。</p>
<p>グローバル FIFO サイズ変更フローを使用するには、最初からやり直す必要があります。Vitis HLS GUI を終了し、コマンド ラインで次を実行し、再起動します。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span></pre></div>
</div>
<p>次の手順に従ってください。</p>
<p>自動の FIFO サイズ変更をイネーブルにするには:</p>
<ol><li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) をクリックして、C 合成を再実行します。</p></li> <li><p>緑色の <strong>[Run]</strong> コマンド (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) の隣にあるドロップダウン リストから <code class="docutils literal notranslate"><span class="pre">Co-Simulation</span></code> を選択し、C/RTL 協調シミュレーションを実行します。</p></li> <li><p><code class="docutils literal notranslate"><span class="pre">Co-simulation</span> <span class="pre">Dialog</span></code> で、<code class="docutils literal notranslate"><span class="pre">Dynamic</span> <span class="pre">Deadlock</span> <span class="pre">Prevention</span></code> オプションを選択します (次の図を参照) 。<code class="docutils literal notranslate"><span class="pre">OK</span></code> をクリックして、C/RTL 協調シミュレーションを開始します。</p>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/auto_fifo_setting.png" /></p></li> <li><p>C/RTL 協調シミュレーションは、デッドロックの原因となるチャネルに対して適切な FIFO サイズを検出する間しばらく実行されます。しばらくして、協調シミュレーションが正常に終了すると停止します。</p></li> <li><p>Dataflow Viewer を再起動すると、[Process] および [Channel] の表の横に新しい <code class="docutils literal notranslate"><span class="pre">FIFO</span> <span class="pre">Sizing</span></code> 表が表示されます。この新しい表は、アルゴリズムによって決定された新しい FIFO サイズを記録します。</p></li> <li><p>プラグマや指示子を使用して、ソース コード内で手動でこれらの FIFO サイズをバックアノテートできます。</p></li></ol>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/auto_fifo_sizing.png" /></p>
</div>
</div>
<div class="section" id="takeaways">
<h2>まとめ<a class="headerlink" href="#takeaways" title="Permalink to this heading">¶</a></h2>
<p>まとめると、Dataflow Viewer では、次のスループット解析タスクを利用できます。</p><ul class="simple"> <li><p>グラフには、DATAFLOW 領域の全体的なトポロジが表示され、どのタイプのチャネル (FIFO/PIPO) が DATAFLOW 領域のタスク間通信のために推論されたかが示されます。各チャネルおよびプロセスを解析すると、デッドロックや FIFO のサイズが適切でないためにスループットが小さいなどの問題を解決するのに役立ちます。</p></li> <li><p>協調シミュレーションのデータがあると、シミュレーション過程で FIFO の最大サイズを確認することにより、FIFO のサイズを決定する際の基準となるので、FIFO サイズの問題を解決できます。また、協調シミュレーションでは、自動デッドロック検出により、デッドロックに関係するプロセスおよびチャネルがハイライトされるので、問題をすばやく見つけて修正できます。</p></li> <li><p>協調シミュレーション後にレポートされるデータには、FIFO のサイズだけでなく、プロセスおよびチャネルごとに、入力を待っていたり、出力の書き込みがブロックされたりしているストール時間も示されます。このグラフがあると、これらの問題を理解し、プロデューサーが高速でコンシューマーが高速 (またはその逆) の状況に対処するためチャネルのサイズをどのように管理すればよいかを判断するのに役立ちます。また、DATAFLOW 領域の真ん中で入力から読み出すことがパフォーマンスにどのように影響するかを理解するのにも有益です。これがパフォーマンスに影響する状況はよくあります。</p></li> </ul>
</br>
<hr/>
<p align="center"><b><a href="/docs/vitis-getting-started/">入門コースの初めに戻る</a> &mdash; <a href="./README.html">チュートリアルの初めに戻る</a></b></p><p align="center"><sup>Copyright&copy; 2021-2022 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>.footer { position: fixed; left: 0; bottom: 0; width: 100%; }</style>
				  
				  <footer>

  <hr/>

  <div role="contentinfo">
    <p>© Copyright 2019-2022, Xilinx, Inc.. <span class="lastupdated">最終更新日 2022 年 5 月 16 日。内容に相違が生じる場合には原文を優先します。英語版の更新に対応していないことがありますので、日本語版は参考用としてご使用の上、最新情報につきましては、必ず<a href="https://github.com/Xilinx/Vitis-Tutorials">最新英語版</a>をご参照ください。</span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div> </br> Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>