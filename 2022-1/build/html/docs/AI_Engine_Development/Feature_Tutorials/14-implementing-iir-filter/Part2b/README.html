


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../../../../../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../../../../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

	<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->
<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="37701bd4-e5c0-4ee3-9329-e7475d0b13a7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
		<!-- Google Tag Manager -->
	<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
	<!-- End Google Tag Manager -->
	
        <!-- Google Tag Manager -->
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
        <!-- End Google Tag Manager -->	

  
  
  
  

  
      <script type="text/javascript" src="../../../../../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../../../../../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/Searchbox.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/header-footer.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/pro.min.css" media="all" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
 <div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">

    
    

    



<div class="xf-content-height">
    

<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
    
    <div class="header parbase aem-GridColumn aem-GridColumn--default--12"><noindex>
	<header data-component="header" class="site-header">
		<nav class="navbar navbar-default">
			<div class="container-fluid main-nav">
				<div class="row">
					<div class="navbar-column col-xs-4 col-sm-5">
						<ul class="nav navbar-nav hidden-xs">
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
								</li>
							</ul>
							
						<ul class="nav navbar-nav hidden-sm hidden-md hidden-lg">
							<li>
									<button data-target="#header-container-0" data-function="toggle">Solutions</button>
								</li>
							<li>
									<button data-target="#header-container-1" data-function="toggle">Products</button>
								</li>
							<li>
									<button data-target="#header-container-2" data-function="toggle">Company</button>
								</li>
							</ul>
							
						<div id="header-container-0" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-1" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-2" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							</div>
					<div class="logo-column col-xs-4 col-sm-2">
						<div class="logo">
							<a target="_blank" href="https://www.xilinx.com/">
								<img src="https://github.com/Xilinx/Image-Collateral/blob/main/xilinx-header-logo.svg?raw=true" title="Xilinx Inc"/>
							</a>
						</div>
					</div>

				</div>
			</div>
			</nav></header></noindex></div>
		
	
</div>

    
</div>
</div>

<div class="calloutBanner parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><div class="callout-banner">
    Xilinx is now a part of <a target="_blank" href="https://www.amd.com/en/corporate/xilinx-acquisition">AMD</a> |  <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Learn More</a>
</div>
</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home" alt="Documentation Home"> Vitis™ Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2022.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/index.html">Main</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">AI Engine</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../AI_Engine_Development.html">AI Engine Development</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../../../../../_sources/docs/AI_Engine_Development/Feature_Tutorials/14-implementing-iir-filter/Part2b/README.md.txt"
						rel="nofollow">Show Source</a></li>
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Vitis™ Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Implementing an IIR Filter on the AI Engine - Part 2b</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../../_sources/docs/AI_Engine_Development/Feature_Tutorials/14-implementing-iir-filter/Part2b/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <table class="sphinxhide" width="100%">
 <tr width="100%">
    <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>AI Engine Development</h1>
    <a href="https://www.xilinx.com/products/design-tools/vitis.html">See Vitis™ Development Environment on xilinx.com</br></a>
    <a href="https://www.xilinx.com/products/design-tools/vitis/vitis-ai.html">See Vitis-AI™ Development Environment on xilinx.com</a>
    </td>
 </tr>
</table><div class="section" id="implementing-an-iir-filter-on-the-ai-engine-part-2b">
<h1>Implementing an IIR Filter on the AI Engine - Part 2b<a class="headerlink" href="#implementing-an-iir-filter-on-the-ai-engine-part-2b" title="Permalink to this heading">¶</a></h1>
<p><em><strong>Version: Vitis 2022.1</strong></em></p>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this heading">¶</a></h2>
<p>In Part 2a, we examined the generated assembler code and found that there is a <code class="docutils literal notranslate"><span class="pre">NOP</span></code> (no operation) between the <code class="docutils literal notranslate"><span class="pre">VFPMAC</span></code> (vector floating-point multiply-accumulate) mnemonics. This <code class="docutils literal notranslate"><span class="pre">NOP</span></code> is unavoidable as a floating-point accumulation requires 2 cycles (see Fig. 26 of <a class="reference external" href="https://www.xilinx.com/support/documentation/architecture-manuals/am009-versal-ai-engine.pdf">AM009</a>).</p>
<p>There are 2 possible solutions to “squeeze out” the <code class="docutils literal notranslate"><span class="pre">NOPs</span></code> to allow a floating-point multiply-accumulate on each cycle.</p>
<ul class="simple">
<li><p>split the matrix-vector multiplication into 2 separate multiply-accumulate operations such that a floating-point accumulation can be performed on each cycle</p></li>
<li><p>use fixed-point (which uses one cycle for accumulation)</p></li>
</ul>
<p>We will focus on splitting the floating-point matrix-vector multiplication in this section.</p>
<p>Note that instead of the “traditional” method of multiplying each row of the matrix by the column vector, we are effectively scaling each <em>column</em> of the matrix by the corresponding element in the vector with the multiply-accumulate API.</p>
<p><img alt="Fig. 1" src="../../../../../_images/eqn5.PNG" /></p>
<p>Thus, splitting the vector additions into even and odd parts will allow us to perform independent multiply-accumulate operations:</p>
<p><img alt="Fig. 2" src="../../../../../_images/eqn6.PNG" /></p>
<p>Also note that the AI engine has 2 load units. The Julia program <code class="docutils literal notranslate"><span class="pre">aie_iir_2b.jl</span></code> has been modified to split the matrix into even and odd columns and generate two separate header files.</p>
<p>We start by using the AI Engine APIs.</p>
</div>
<div class="section" id="kernel-header">
<h2>Kernel Header<a class="headerlink" href="#kernel-header" title="Permalink to this heading">¶</a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef __KERNEL_HPP__	</span><span class="c1">// include guard to prevent multiple inclusion</span>

<span class="w">	</span><span class="cp">#define __KERNEL_HPP__</span>

<span class="w">	</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;adf.h&gt;</span><span class="c1">			// Adaptive DataFlow header</span><span class="cp"></span>
<span class="w">	</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;aie_api/aie.hpp&gt;</span><span class="c1">	// header files for high-level intrinsics</span><span class="cp"></span>

<span class="w">	</span><span class="k">typedef</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vector8f</span><span class="p">;</span><span class="w">		</span><span class="c1">// vector of 8 floating-point elements</span>
<span class="w">	</span><span class="k">typedef</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Vector16f</span><span class="p">;</span><span class="w">	</span><span class="c1">// vector of 8 floating-point elements</span>
<span class="w">	</span><span class="k">typedef</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">accum</span><span class="o">&lt;</span><span class="n">accfloat</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="n">VAcc8f</span><span class="p">;</span><span class="w">		</span><span class="c1">// accumulator with 8 floating-point elements</span>

<span class="w">	</span><span class="n">define</span><span class="w"> </span><span class="n">USE_API</span><span class="w">	</span><span class="c1">// comment out to use low-level intrinsics</span>

<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">burst_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w">	</span><span class="c1">// process burst_cnt * 8 samples per function invocation</span>

<span class="w">	</span><span class="k">template</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">id</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="n">SecondOrderSection</span><span class="p">(</span><span class="w"></span>
<span class="w">		</span><span class="n">input_window</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">idata</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="n">output_window</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">odata</span><span class="p">,</span><span class="w"></span>
<span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_e</span><span class="p">)[</span><span class="mi">48</span><span class="p">],</span><span class="w">		</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (even columns)</span>
<span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_o</span><span class="p">)[</span><span class="mi">48</span><span class="p">]</span><span class="w">		</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (odd columns)</span>
<span class="w">	</span><span class="p">);</span><span class="w"></span>

<span class="cp">#endif </span><span class="c1">// __KERNEL_HPP__</span>
</pre></div>
</div>
</div>
<div class="section" id="kernel-code-ai-engine-api">
<h2>Kernel Code (AI Engine API)<a class="headerlink" href="#kernel-code-ai-engine-api" title="Permalink to this heading">¶</a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;aie_api/aie_adf.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel.hpp&quot;</span><span class="cp"></span>

<span class="k">template</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">id</span><span class="o">&gt;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">SecondOrderSection</span><span class="p">(</span><span class="w"></span>
<span class="w">	</span><span class="n">input_window</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">idata</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">output_window</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">odata</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_e</span><span class="p">)[</span><span class="mi">48</span><span class="p">],</span><span class="w">			</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (even columns)</span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_o</span><span class="p">)[</span><span class="mi">48</span><span class="p">]</span><span class="w">			</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (odd columns)</span>
<span class="w">	</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="n">Vector8f</span><span class="w"> </span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">zeros</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">();</span><span class="w">	</span><span class="c1">// clear states</span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">burst_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span><span class="c1">//chess_prepare_for_pipelining</span>
<span class="w">	</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="n">Vector8f</span><span class="w"> </span><span class="n">xreg_hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window_readincr_v</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span><span class="w">		</span><span class="c1">// fetch input samples</span>
<span class="w">		</span><span class="n">Vector16f</span><span class="w"> </span><span class="n">xreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">concat</span><span class="p">(</span><span class="n">state_reg</span><span class="p">,</span><span class="w"> </span><span class="n">xreg_hi</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">VAcc8f</span><span class="w"> </span><span class="n">acc_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">zeros</span><span class="o">&lt;</span><span class="n">accfloat</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">();</span><span class="w">	</span><span class="c1">// even accumulator</span>
<span class="w">		</span><span class="n">VAcc8f</span><span class="w"> </span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">zeros</span><span class="o">&lt;</span><span class="n">accfloat</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">();</span><span class="w">	</span><span class="c1">// odd accumulator</span>

<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">			</span><span class="n">Vector8f</span><span class="w"> </span><span class="n">coeff_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">load_v</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_e</span><span class="p">[</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="p">]);</span><span class="w">		</span><span class="c1">// even columns</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">xreg_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xreg</span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="n">acc_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">mac</span><span class="p">(</span><span class="n">acc_e</span><span class="p">,</span><span class="w"> </span><span class="n">xreg_e</span><span class="p">,</span><span class="w"> </span><span class="n">coeff_e</span><span class="p">);</span><span class="w"></span>

<span class="w">			</span><span class="n">Vector8f</span><span class="w"> </span><span class="n">coeff_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">load_v</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_o</span><span class="p">[</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="p">]);</span><span class="w">		</span><span class="c1">// odd columns</span>
<span class="w">			</span><span class="kt">float</span><span class="w"> </span><span class="n">xreg_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xreg</span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">mac</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="n">xreg_o</span><span class="p">,</span><span class="w"> </span><span class="n">coeff_o</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="c1">// end for (auto j = 0; j &lt; 6; j ++)</span>

<span class="w">		</span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aie</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="n">acc_e</span><span class="p">.</span><span class="n">to_vector</span><span class="p">());</span><span class="w">	</span><span class="c1">// acc_o += acc_e</span>
<span class="w">		</span><span class="n">Vector8f</span><span class="w"> </span><span class="n">yout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc_o</span><span class="p">.</span><span class="n">to_vector</span><span class="p">();</span><span class="w"></span>

<span class="w">		</span><span class="c1">// update states</span>
<span class="w">		</span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xreg_hi</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">state_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yout</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">state_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">yout</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="n">window_writeincr</span><span class="p">(</span><span class="n">odata</span><span class="p">,</span><span class="w"> </span><span class="n">yout</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="c1">// end for (auto i = 0; i &lt; burst_cnt; i++)</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// end SecondOrderSection()</span>
</pre></div>
</div>
<p>Note the 2 loops in the function:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">burst_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">	</span><span class="c1">// process more samples to reduce overhead</span>
<span class="w">	</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">	</span><span class="c1">// matrix-vector multiplication</span>
<span class="w">		</span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The outer <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is added such that more samples can be processed during each function call, thereby reducing overhead and improving throughput.</p>
</div>
<div class="section" id="graph-code">
<h2>Graph Code<a class="headerlink" href="#graph-code" title="Permalink to this heading">¶</a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef __GRAPH_H__			</span><span class="c1">// include guard to prevent multiple inclusion</span>

<span class="w">	</span><span class="cp">#define __GRAPH_H__</span>

<span class="w">	</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;adf.h&gt;</span><span class="c1">		// Adaptive DataFlow header</span><span class="cp"></span>

<span class="w">	</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel.hpp&quot;</span><span class="cp"></span>

<span class="w">	</span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">adf</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="c1">// dataflow graph declaration</span>
<span class="w">	</span><span class="k">class</span><span class="w"> </span><span class="nc">the_graph</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="p">{</span><span class="w">	</span><span class="c1">// inherit all properties of the adaptive     dataflow graph</span>

<span class="w">		</span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">			</span><span class="n">input_plio</span><span class="w"> </span><span class="n">pl_in</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">output_plio</span><span class="w"> </span><span class="n">pl_out</span><span class="p">;</span><span class="w"></span>

<span class="w">			</span><span class="n">kernel</span><span class="w"> </span><span class="n">section1</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">input_port</span><span class="w"> </span><span class="n">cmtx_e</span><span class="p">;</span><span class="w">	</span><span class="c1">// input port for SIMD matrix coefficients (even columns)</span>
<span class="w">			</span><span class="n">input_port</span><span class="w"> </span><span class="n">cmtx_o</span><span class="p">;</span><span class="w">	</span><span class="c1">// input port for SIMD matrix coefficients (odd columns)</span>

<span class="w">			</span><span class="c1">// constructor</span>
<span class="w">			</span><span class="n">the_graph</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">				</span><span class="c1">// associate the kernel with the function to be executed</span>
<span class="w">				</span><span class="n">section1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">SecondOrderSection</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>

<span class="w">				</span><span class="n">pl_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_plio</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Input&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plio_32_bits</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;data/input.dat&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">				</span><span class="n">pl_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">output_plio</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Output&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plio_32_bits</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;output.dat&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">				</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">num_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">burst_cnt</span><span class="p">;</span><span class="w"></span>

<span class="w">				</span><span class="c1">// establish connections</span>

<span class="w">				</span><span class="n">connect</span><span class="o">&lt;</span><span class="n">parameter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmtx_e</span><span class="p">,</span><span class="w"> </span><span class="n">adf</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="n">section1</span><span class="p">.</span><span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="w"></span>
<span class="w">				</span><span class="n">connect</span><span class="o">&lt;</span><span class="n">parameter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmtx_o</span><span class="p">,</span><span class="w"> </span><span class="n">adf</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="n">section1</span><span class="p">.</span><span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span><span class="w"></span>

<span class="w">				</span><span class="n">connect</span><span class="o">&lt;</span><span class="n">window</span><span class="o">&lt;</span><span class="n">num_bytes</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">pl_in</span><span class="p">.</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">section1</span><span class="p">.</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">				</span><span class="c1">// window size in bytes</span>
<span class="w">				</span><span class="n">connect</span><span class="o">&lt;</span><span class="n">window</span><span class="o">&lt;</span><span class="n">num_bytes</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">section1</span><span class="p">.</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">pl_out</span><span class="p">.</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">				</span><span class="c1">// specify which source code file contains the kernel function</span>
<span class="w">				</span><span class="n">source</span><span class="p">(</span><span class="n">section1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;kernel.cpp&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">				</span><span class="c1">// !!! temporary value: assumes this kernel dominates the AI engine tile !!!</span>
<span class="w">				</span><span class="n">runtime</span><span class="o">&lt;</span><span class="n">ratio</span><span class="o">&gt;</span><span class="p">(</span><span class="n">section1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>

<span class="w">			</span><span class="p">}</span><span class="w"> </span><span class="c1">// end the_graph()</span>

<span class="w">	</span><span class="p">};</span><span class="w"> </span><span class="c1">// end class the_graph</span>

<span class="cp">#endif </span><span class="c1">// __GRAPH_H__</span>
</pre></div>
</div>
<p>Note that the graph uses the <em>enhanced programming model</em> (see UG1076 (v2021.2)) which eliminates the need for a global <code class="docutils literal notranslate"><span class="pre">simulation::platform</span></code> variable.</p>
</div>
<div class="section" id="testbench-code">
<h2>Testbench Code<a class="headerlink" href="#testbench-code" title="Permalink to this heading">¶</a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;graph.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;C1_e.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;C1_o.h&quot;</span><span class="cp"></span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span><span class="w"></span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">adf</span><span class="p">;</span><span class="w"></span>

<span class="c1">// specify the DFG</span>
<span class="n">the_graph</span><span class="w"> </span><span class="n">my_graph</span><span class="p">;</span><span class="w"></span>

<span class="c1">// main simulation program</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">	</span><span class="n">my_graph</span><span class="p">.</span><span class="n">init</span><span class="p">();</span><span class="w">	</span><span class="c1">// load the DFG into the AI engine array, establish connectivity, etc.</span>

<span class="w">	</span><span class="n">my_graph</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_graph</span><span class="p">.</span><span class="n">cmtx_e</span><span class="p">,</span><span class="w"> </span><span class="n">C1_e</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"></span>
<span class="w">	</span><span class="n">my_graph</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_graph</span><span class="p">.</span><span class="n">cmtx_o</span><span class="p">,</span><span class="w"> </span><span class="n">C1_o</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">my_graph</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w">	</span><span class="c1">// run the DFG for the specified number of iterations</span>

<span class="w">	</span><span class="n">my_graph</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w">		</span><span class="c1">// housekeeping</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="p">}</span><span class="w"> </span><span class="c1">// end main()</span>
</pre></div>
</div>
</div>
<div class="section" id="analysis-using-ai-engine-api">
<h2>Analysis (using AI Engine API)<a class="headerlink" href="#analysis-using-ai-engine-api" title="Permalink to this heading">¶</a></h2>
<div class="section" id="generated-code">
<h3>Generated Code<a class="headerlink" href="#generated-code" title="Permalink to this heading">¶</a></h3>
<p><img alt="Fig. 3" src="../../../../../_images/hli_asm.PNG" />
In the generated assembly code, note that there are 13 <code class="docutils literal notranslate"><span class="pre">VFPMAC</span></code>s: 6 for each even and odd column, and another for summing the final accumulator results. Note that the <code class="docutils literal notranslate"><span class="pre">VFPMAC</span></code> instructions are not as tightly packed, i.e., some <code class="docutils literal notranslate"><span class="pre">VFPMAC</span></code>s have other instructions between them.</p>
</div>
<div class="section" id="throughput">
<h3>Throughput<a class="headerlink" href="#throughput" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code> variable determines the total number of samples processed during each function call. The inner loop processes 8 samples per iteration, so the total number of processed samples will be <code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code> * 8.</p>
<p>The throughput is obtained as follows (see <code class="docutils literal notranslate"><span class="pre">api_thruput.xlsx</span></code>):</p>
<ul class="simple">
<li><p>build and run the design</p></li>
<li><p>open <code class="docutils literal notranslate"><span class="pre">aiesimulator_output/default.aierun_summary</span></code></p></li>
<li><p>Get the <code class="docutils literal notranslate"><span class="pre">Total</span> <span class="pre">Function</span> <span class="pre">+</span> <span class="pre">Descendants</span> <span class="pre">Time</span> <span class="pre">(cycles)</span></code> for the <code class="docutils literal notranslate"><span class="pre">main</span></code> function (<code class="docutils literal notranslate"><span class="pre">num_cycles</span></code>)</p></li>
<li><p>Throughput = <code class="docutils literal notranslate"><span class="pre">clk_freq</span></code> * (<code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code> * 8)/num_cycles</p></li>
</ul>
<p>The thoughput with a 1GHz clock for different values of <code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code> are shown below.</p>
<p><b>IIR Throughput (with API)</b>
|                           |       |       |       |       |       |       |     |
|—————————|——-|——-|——-|——-|——-|——-|——-|
|burst_cnt					|1		|8		|16		|32		|64		|128	|256	|
|num_samples				|8		|64		|128	|256	|512	|1024	|2048	|
|num_cycles (API)			|289	|799	|1508	|2925	|5761	|11431	|22772	|					
|API Throughput (Msa/sec))	|27.68	|80.10	|84.88	|87.52	|88.87	|89.58	|89.94	|</p>
<p>*clk_freq: 1GHz</p>
<p>The AI Engine APIs are a header-only implementation which act as a “buffer” between the user and the low-level intrinsics (LLI) to increase the level of abstraction. Is it possible that the API adds some overhead?</p>
<p>We modify the kernel code to use low-level intrinsics (LLI).</p>
</div>
</div>
<div class="section" id="kernel-code-lli">
<h2>Kernel Code (LLI)<a class="headerlink" href="#kernel-code-lli" title="Permalink to this heading">¶</a></h2>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;aie_api/aie_adf.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;kernel.hpp&quot;</span><span class="cp"></span>

<span class="k">template</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">id</span><span class="o">&gt;</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">SecondOrderSection</span><span class="p">(</span><span class="w"></span>
<span class="w">	</span><span class="n">input_window_float</span><span class="w"> </span><span class="o">*</span><span class="n">idata</span><span class="p">,</span><span class="w"></span>
<span class="w">	</span><span class="n">output_window_float</span><span class="w"> </span><span class="o">*</span><span class="n">odata</span><span class="p">,</span><span class="n">iteration</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_e</span><span class="p">)[</span><span class="mi">48</span><span class="p">],</span><span class="w">			</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (even columns)</span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">C_o</span><span class="p">)[</span><span class="mi">48</span><span class="p">]</span><span class="w">			</span><span class="c1">// run-time parameter: SIMD matrix of coefficients (odd columns)</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="n">v8float</span><span class="w"> </span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null_v8float</span><span class="p">();</span><span class="w"></span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">burst_cnt</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">		</span><span class="n">v8float</span><span class="w"> </span><span class="n">xreg_hi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window_readincr_v8</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">v16float</span><span class="w"> </span><span class="n">xreg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">concat</span><span class="p">(</span><span class="n">state_reg</span><span class="p">,</span><span class="w"> </span><span class="n">xreg_hi</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="n">v8float</span><span class="w"> </span><span class="n">acc_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null_v8float</span><span class="p">();</span><span class="w"></span>
<span class="w">		</span><span class="n">v8float</span><span class="w"> </span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null_v8float</span><span class="p">();</span><span class="w"></span>

<span class="w">		</span><span class="n">v8float</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_coeff_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v8float</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">C_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">		</span><span class="n">v8float</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_coeff_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v8float</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">C_o</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">		</span><span class="n">chess_flatten_loop</span><span class="w"></span>
<span class="w">		</span><span class="p">{</span><span class="w"></span>

<span class="w">			</span><span class="n">v8float</span><span class="w"> </span><span class="n">coeff_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_coeff_e</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">acc_e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpmac</span><span class="p">(</span><span class="n">acc_e</span><span class="p">,</span><span class="w"> </span><span class="n">xreg</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">coeff_e</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76543210</span><span class="p">);</span><span class="w"></span>

<span class="w">			</span><span class="n">v8float</span><span class="w"> </span><span class="n">coeff_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr_coeff_o</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpmac</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="n">xreg</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">coeff_o</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x76543210</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="c1">// end for (auto j = 0; j &lt; 6; j++)</span>

<span class="w">		</span><span class="n">acc_o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpadd</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="n">acc_e</span><span class="p">);</span><span class="w"></span>
<span class="w">		</span><span class="n">window_writeincr</span><span class="p">(</span><span class="n">odata</span><span class="p">,</span><span class="w"> </span><span class="n">acc_o</span><span class="p">);</span><span class="w"></span>

<span class="w">		</span><span class="c1">// update states</span>
<span class="w">		</span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xreg_hi</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upd_elem</span><span class="p">(</span><span class="n">state_reg</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">ext_elem</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">));</span><span class="w"></span>
<span class="w">		</span><span class="n">state_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">upd_elem</span><span class="p">(</span><span class="n">state_reg</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">ext_elem</span><span class="p">(</span><span class="n">acc_o</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">));</span><span class="w"></span>

<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="c1">// end for (auto i = 0; i &lt; burst_cnt; i++)</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// end SecondOrderSection()</span>
</pre></div>
</div>
<p>Note the use of the <code class="docutils literal notranslate"><span class="pre">chess_flatten_loop</span></code> pragma. This pragma unrolls the loop completely, eliminating the loop construct. Documentation on compiler pragmas may be found in the AI Engine Lounge.</p>
<p>Note: In the code provided, selecting between API and LLI is performed by defining or commenting out <code class="docutils literal notranslate"><span class="pre">USE_API</span></code> on line 25 of <code class="docutils literal notranslate"><span class="pre">kernel.hpp</span></code>.</p>
<p>The generated assembly code is shown below.
<img alt="Fig. 4" src="../../../../../_images/lli_asm.PNG" />
Note the “tighter” spacing between <code class="docutils literal notranslate"><span class="pre">VFPMAC</span></code>s. Also note that the <code class="docutils literal notranslate"><span class="pre">SecondOrderSection&lt;1&gt;</span></code> function has been “absorbed” into the main function, and the there are <em>two</em> unrolled matrix-vector multiplication loops, effectively halving the number of iterations of the outer loop.</p>
<p>The measured throughput is shown below (see <code class="docutils literal notranslate"><span class="pre">lli_thruput.xlsx</span></code>).</p>
<p><b>IIR Throughput (with LLI)</b>
|                           |       |       |       |       |       |       |     |
|—————————|——-|——-|——-|——-|——-|——-|——-|
|burst_cnt					|1		|8		|16		|32		|64		|128	|256	|
|num_samples				|8		|64		|128	|256	|512	|1024	|2048	|
|num_cycles (LLI)			|224	|464	|877	|1702	|3354	|6656	|13261	|					
|LLI Throughput (Msa/sec))	|35.71	|137.93	|145.95	|150.41	|152.65	|153.85	|154.44	|</p>
<p>*clk_freq: 1GHz</p>
<p>Comparing the API and LLI throughputs:
<img alt="Fig. 5" src="../../../../../_images/hli_vs_lli.PNG" /></p>
<ul class="simple">
<li><p>LLI provides a better throughput than API for the same <code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code></p></li>
<li><p>The throughput “saturates” at around <code class="docutils literal notranslate"><span class="pre">burst_cnt</span></code> = 64</p></li>
</ul>
</div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this heading">¶</a></h2>
<p>The AI Engine API is intended to improve productivity by increasing the level of abstraction, relative to the low-level intrinsics.
<img alt="Fig. 6" src="../../../../../_images/api_vs_lli_table.PNG" />
We recommend using the AI Engine API, and only use low-level intrinsics to squeeze out more performance to meet target specifications.</p>
<p>Throughput may be improved using the following techniques:</p>
<ul class="simple">
<li><p>Reduce function call ovehead by processing as many samples within the function as possible</p></li>
<li><p>For floating-point accumulation, use 2 accumulators with low-level intrinsics</p></li>
</ul>
<p>Can the throughput be improved even further?</p>
<ul class="simple">
<li><p>Floating-point allows 8 MACs per cycle. Using 32-bit fixed-point coefficients with 16-bit data allows 16 MACs per cycle, potentially doubling the throughput. 16-bit fixed-point coefficients with 16-bit data allows 32 MACs per cycle, potentially quadrupling the throughput. 16-bit fixed-point coefficients with 8-bit data allows 64 MACs per cycle, potentially improving the throughput by 8x.</p></li>
<li><p>Assuming that we stick with a floating-point implementation, doubling the number of processed samples <em>and</em> the number of AI engines (i.e., 2 AI engines, each processing 8 samples from a 16-sample window) <em>may</em> double the throughput.</p></li>
</ul>
</div>
</div>
<div class="section" id="support">
<h1>Support<a class="headerlink" href="#support" title="Permalink to this heading">¶</a></h1>
<p>GitHub issues will be used for tracking requests and bugs. For questions go to <a class="reference external" href="http://forums.xilinx.com/">forums.xilinx.com</a>.</p>
</div>
<div class="section" id="license">
<h1>License<a class="headerlink" href="#license" title="Permalink to this heading">¶</a></h1>
<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License.</p>
<p>You may obtain a copy of the License at <a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p align="center"><sup>&copy; Copyright 2021 Xilinx, Inc.</sup></p></div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on May 16, 2022.
      </span>

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
														
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<div class="lang-select dropup hidden-md hidden-lg">
		<button data-toggle="dropdown">
			<span class="fas fa-globe" aria-hidden="true"></span>
			<span>
				
					English
				</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a target="_blank" href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a target="_blank" href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a target="_blank" href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a target="_blank" href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
																	<div class="lang-select dropup hidden-xs hidden-sm">
	<button data-toggle="dropdown">
		<span class="fas fa-globe" aria-hidden="true"></span>
		<span>
			
				English
			</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a target="_blank" href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a target="_blank" href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
															</div>
														</div>
														<div class="col-md-pull-5 col-lg-pull-5 col-md-5 col-lg-5">
															<span class="copyright">©2022 Advanced Micro Devices, Inc</span>
														</div>

													</div>
													                    <div class="movethisrowtoleft row">
                        <div class="col-xs-24">
                            <ul class="sub-menu">
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a></li>
                                <li><a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a></li>
                                <li><a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a></li>
                                <li><a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a></li>
								<li><a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a></li>
                                <li><a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></li>
                            </ul>
                        </div>
                    </div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
<div class="backToTop parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><noindex>
    <span data-component="backToTopButton" class="backToTopButton loaded">
        <ul>
            <li>
                <a href="https://www.author.xilinx.com/xx/rebrand/amd/en-amd-xilinx-header-footer.html#top" class="btn top">
                    <span class="fas fa-angle-up" aria-hidden="true"></span>
                </a>
            </li>
        </ul>
    </span>
</noindex></div>
			</div>
		</div>


		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>