<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>Mixing C++ and RTL Kernels &mdash; Vitis™ Tutorials 2020.2 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Vitis HLS Analysis and Optimization" href="../03-dataflow_debug_and_optimization/README.html" />
    <link rel="prev" title="Getting Started with RTL Kernels" href="../01-rtl_kernel_workflow/README.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../../../../index.html" class="icon icon-home"> Vitis™ Tutorials
            <img src="../../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2020.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/README.html">Master</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis/README.html">Vitis Flow 101 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis_HLS/README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Accelerators</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction/README.html">Introduction to Vitis Hardware Accelerators Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/02-bloom/README.html">Optimizing Accelerated FPGA Applications: Bloom Filter Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/01-convolution-tutorial/README.html">Accelerating Video Convolution Filtering Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/03-rtl_stream_kernel_integration/README.html">Mixed Kernels Design Tutorial with AXI Stream and Vitis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/04-traveling-salesperson/README.html">The Travelling Salesman Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/05-bottom_up_rtl_kernel/README.html">Bottom-up RTL Kernel Flow with Vitis for Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-rtl_kernel_workflow/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mixing C++ and RTL Kernels</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-overview">Tutorial Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#before-you-begin">Before You Begin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-tutorial-reference-files">Accessing the Tutorial Reference Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#building-an-application-with-c-based-kernel">Building an Application with C++ Based Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#c-based-kernel">C++ Based Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-code">Host Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-the-application">Build the Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-emulation">Run Emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#review-the-application-timeline">Review the Application Timeline</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#putting-it-all-together">Putting it All Together</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#building-an-application-with-c-and-rtl-based-kernels">Building an Application with C++ and RTL-Based Kernels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rtl-based-kernel">RTL-Based Kernel</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#create-the-vitis-project">Create the Vitis Project</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-vivado-design-suite-project">The Vivado Design Suite Project</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-code-updates">Host Code Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-and-emulation-with-c-and-rtl-based-kernels">Build and Emulation with C++ and RTL Based Kernels</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03-dataflow_debug_and_optimization/README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime and System Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/01-host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/02-ivas-ml/README.html">IVAS ZCU104 ML Acceleration Reference Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/01-mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/02-using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/03-controlling-vivado-implementation/README.html">Controlling Vivado Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/04-using-hbm/README.html">Using HBM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vitis Platform Creation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/01-Overview/README.html">Platform Creation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/02-Edge-AI-ZCU104/README.html">Vitis Custom Embedded Platform Creation Example on ZCU104</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/03_Edge_VCK190/README.html">Versal Custom Platform Creation Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/">Main</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Vitis™ Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Mixing C++ and RTL Kernels</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/Hardware_Accelerators/Feature_Tutorials/02-mixing-c-rtl-kernels/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>2020.2 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/tree/2020.1">See 2020.1 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="mixing-c-and-rtl-kernels">
<h1>Mixing C++ and RTL Kernels<a class="headerlink" href="#mixing-c-and-rtl-kernels" title="Permalink to this heading">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>In the Vitis™ core development kit, an application program is split between a host application and hardware accelerated kernels. The host application is developed in C/C++ with OpenCL™ API calls. The hardware kernels, on the other hand, can be developed in C/C++, OpenCL C, or RTL. In fact, the Vitis core development kit applications can use any combination of kernels developed in the different languages. The host code is indifferent to how the kernel was developed; it uses the same function call.</p>
</div>
<div class="section" id="tutorial-overview">
<h2>Tutorial Overview<a class="headerlink" href="#tutorial-overview" title="Permalink to this heading">¶</a></h2>
<p>This tutorial demonstrates an application using two kernels, one designed in C++ and the other designed in RTL, with the host code accessing the kernels in an identical manner.</p>
<p>This tutorial is split into two parts:</p>
<ul class="simple">
<li><p>In the first part, you will build an application (host and kernel) with one C++ based kernel. The host code, including the kernel function call, is reviewed.</p></li>
<li><p>In the second part, an RTL-based kernel will be added to the application.  The updated host code, including the function call to the additional kernel, is reviewed.</p></li>
</ul>
<p>During both parts, the application is built using a Makefile. Software emulation is run in step one and hardware emulation is run in step two. In both steps, the generated Application Timeline will be reviewed to highlight the kernels being called and run by the host application.</p>
<p>The host code and C++ kernel code are supplied. The RTL code will be generated using the RTL Kernel Wizard.</p>
</div>
<div class="section" id="before-you-begin">
<h2>Before You Begin<a class="headerlink" href="#before-you-begin" title="Permalink to this heading">¶</a></h2>
<p>This tutorial uses:</p>
<ul class="simple">
<li><p>BASH Linux shell commands.</p></li>
<li><p>2020.1 Vitis core development release and the <em>xilinx_u200_xdma_201830_2</em> platform. If necessary, it can be easily extended to other versions and platforms.</p></li>
</ul>
<blockquote>
<div><p><strong>IMPORTANT:</strong></p>
<ul class="simple">
<li><p>Before running any of the examples, make sure you have installed the Vitis core development kit as described in <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2020_2/vitis_doc/acceleration_installation.html#vhc1571429852245">Installation</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p></li>
<li><p>If you run applications on Xilinx® Alveo™ Data Center accelerator cards, ensure the card and software drivers have been correctly installed by following the instructions on the <a class="reference external" href="https://www.xilinx.com/products/boards-and-kits/alveo.html">Alveo Portfolio page</a>.</p></li>
</ul>
</div></blockquote>
<p>Before running any of the examples, ensure you have set up the Vitis core development kit by running the following commands.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  <span class="c1">#setup Xilinx Vitis tools, XILINX_VITIS and XILINX_VIVADO will be set in this step. source &lt;VITIS install path&gt;/settings64.sh. for example:</span>
  <span class="nb">source</span> /opt/Xilinx/Vitis/2020.2/settings64.sh
  <span class="c1">#Setup runtime. XILINX_XRT will be set in this step</span>
  <span class="nb">source</span> /opt/xilinx/xrt/setup.sh
</pre></div>
</div>
<div class="section" id="accessing-the-tutorial-reference-files">
<h3>Accessing the Tutorial Reference Files<a class="headerlink" href="#accessing-the-tutorial-reference-files" title="Permalink to this heading">¶</a></h3>
<ol class="simple">
<li><p>To access the reference files, type the following into a terminal: <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/Xilinx/Vitis-Tutorials</span></code>.</p></li>
<li><p>Navigate to the <code class="docutils literal notranslate"><span class="pre">Hardware_Accelerators/Feature_Tutorials/02-mixing-c-rtl-kernels</span></code> directory, and then access the <code class="docutils literal notranslate"><span class="pre">reference-files</span></code> directory.</p></li>
</ol>
</div>
</div>
<div class="section" id="building-an-application-with-c-based-kernel">
<h2>Building an Application with C++ Based Kernel<a class="headerlink" href="#building-an-application-with-c-based-kernel" title="Permalink to this heading">¶</a></h2>
<p>In this step, you will build an application, consisting of host code and a C++ kernel using a makefile. For an overview on building an application, refer to the <a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/tree/master/Getting_Started/Vitis">Vitis Flow 1010 Tutorial</a> lab.</p>
<div class="section" id="c-based-kernel">
<h3>C++ Based Kernel<a class="headerlink" href="#c-based-kernel" title="Permalink to this heading">¶</a></h3>
<p>The C++ based kernel adds two input vectors and generates the output result. The source code is found in the following directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">reference</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">kernel_cpp</span><span class="o">/</span>
</pre></div>
</div>
<p>The makefile will build this kernel and add it to the hardware platform (<code class="docutils literal notranslate"><span class="pre">xclbin</span></code>), which can be accessed by the host code.</p>
</div>
<div class="section" id="host-code">
<h3>Host Code<a class="headerlink" href="#host-code" title="Permalink to this heading">¶</a></h3>
<p>The host code for step 1 (<code class="docutils literal notranslate"><span class="pre">host_step1.cpp</span></code>) can be found in the following directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">reference</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">host</span><span class="o">/</span>
</pre></div>
</div>
<p>It sets up the platform and defines global memory buffers and connections to the kernel. The following four important sets of OpenCL API calls in the host code are described. To view these calls, open the <code class="docutils literal notranslate"><span class="pre">host_step1.cpp</span></code> file.</p>
<ul>
<li><p>The first set of code, on lines 189-191, creates the program to execute. It uses the binary container, which contains only the C++ based kernel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="p">::</span><span class="n">Program</span><span class="p">::</span><span class="n">Binaries</span> <span class="n">bins</span><span class="p">;</span>
<span class="n">bins</span><span class="o">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">buf</span><span class="p">,</span><span class="n">nb</span><span class="p">});</span>
<span class="n">cl</span><span class="p">::</span><span class="n">Program</span> <span class="n">program</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">bins</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The second set of code, on line 195, gets the C++ krnl_vadd kernel object from the program, and assigns the name <em>krnl_vector_add.</em> It allows the kernel to be used by the host.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="p">::</span><span class="n">Kernel</span> <span class="n">krnl_vector_add</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="s2">&quot;krnl_vadd&quot;</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The third set of code, on lines 213-216, assigns the krnl_vector_add kernel arguments to the buffers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krnl_vector_add</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buffer_a</span><span class="p">);</span>
<span class="n">krnl_vector_add</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">buffer_b</span><span class="p">);</span>
<span class="n">krnl_vector_add</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">buffer_result</span><span class="p">);</span>
<span class="n">krnl_vector_add</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">DATA_SIZE</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The argument numbers 0, 1, 2, and 3 match the argument order in the <code class="docutils literal notranslate"><span class="pre">krnl_vadd</span></code> definition found in <code class="docutils literal notranslate"><span class="pre">krnl_vadd.cpp</span></code> as follows.</p>
<blockquote>
<div><p><strong>NOTE:</strong> Arguments <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are inputs, and <code class="docutils literal notranslate"><span class="pre">c</span></code> is an output.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">krnl_vadd</span><span class="p">(</span>
             <span class="nb">int</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span>
             <span class="nb">int</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span>
             <span class="nb">int</span><span class="o">*</span> <span class="n">c</span><span class="p">,</span>
             <span class="n">const</span> <span class="nb">int</span> <span class="n">n_elements</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Finally, on line 220, the following OpenCL API launches the krnl_vector_add kernel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">krnl_vector_add</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<p>For complete details on host code programming, refer to <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.2%3Bt=vitis+doc%3Bd=lhv1569273988420.html">Developing Applications</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
</div>
<div class="section" id="build-the-application">
<h3>Build the Application<a class="headerlink" href="#build-the-application" title="Permalink to this heading">¶</a></h3>
<ol>
<li><p>To build the application targeting software emulation, run the following makefile command from the <code class="docutils literal notranslate"><span class="pre">./reference-files/run1</span></code> directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make all <span class="nv">TARGET</span><span class="o">=</span>sw_emu
</pre></div>
</div>
<p>This builds both the host software and hardware binary targeted to software emulation. The makefile will also generate the platform JSON emulation file to use during emulation.</p>
</li>
</ol>
</div>
<div class="section" id="run-emulation">
<h3>Run Emulation<a class="headerlink" href="#run-emulation" title="Permalink to this heading">¶</a></h3>
<p>During emulation, you gather application timeline data, consisting of host and device events, which can be reviewed after emulation has completed on a common timeline. The Application Timeline data collection must be enabled before running the emulation by setting <em>timeline_trace=true</em> option in an <code class="docutils literal notranslate"><span class="pre">xrt.ini</span></code> file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Debug</span><span class="p">]</span>
<span class="n">profile</span><span class="o">=</span><span class="n">true</span>
<span class="n">timeline_trace</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>This file has already been created and is in the <code class="docutils literal notranslate"><span class="pre">run1</span></code> and <code class="docutils literal notranslate"><span class="pre">run2</span></code> directories.</p>
<ol>
<li><p>To run software emulation on the design, set the XCL_EMULATION_MODE environment variable to run the following command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span>sw_emu
</pre></div>
</div>
</li>
<li><p>From within the <code class="docutils literal notranslate"><span class="pre">run1</span></code> directory, to run software emulation, use the following command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./host krnl_vadd.sw_emu.xilinx_u200_xdma_201830_2.xclbin
</pre></div>
</div>
<p>When the application successfully completes, the following message is displayed in the Console window.</p>
<p><code class="docutils literal notranslate"><span class="pre">TEST</span> <span class="pre">WITH</span> <span class="pre">ONE</span> <span class="pre">KERNEL</span> <span class="pre">PASSED</span></code></p>
</li>
</ol>
</div>
<div class="section" id="review-the-application-timeline">
<h3>Review the Application Timeline<a class="headerlink" href="#review-the-application-timeline" title="Permalink to this heading">¶</a></h3>
<p>Review the Application Timeline generated during software emulation to visualize the host events and the kernel running.</p>
<ol>
<li><p>To view the Application Timeline, use the Vitis analyzer by running the following command from within the <code class="docutils literal notranslate"><span class="pre">run1</span></code> directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_analyzer</span> <span class="n">xclbin</span><span class="o">.</span><span class="n">run_summary</span>
</pre></div>
</div>
</li>
<li><p>Click on the <strong>Application Timeline</strong> option on the left to bring up the Application Timeline.
<img alt="Missing Image:Application Timeline 1" src="../../../../_images/mixing-c-rtl-kernels_timeline_one_kernel_vitis.PNG" /></p></li>
<li><p>After reviewing, close the Application Timeline window.</p>
<blockquote>
<div><p><strong>NOTE:</strong> A CU is an instantiation of the kernel on the FPGA.</p>
</div></blockquote>
</li>
</ol>
<div class="section" id="putting-it-all-together">
<h4>Putting it All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">¶</a></h4>
<p>For step 1, the following steps were performed. All commands are run in the <code class="docutils literal notranslate"><span class="pre">./reference-files/run1</span></code> directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the application</span>
make all <span class="nv">TARGET</span><span class="o">=</span>sw_emu

<span class="c1"># Set XCL_EMULATION_MODE environment variable for software emulation</span>
<span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span>sw_emu

<span class="c1"># Run software emulation</span>
./host krnl_vadd.sw_emu.xilinx_u200_xdma_201830_2.xclbin

<span class="c1"># View Application Timeline Trace in Vitis Analyzer</span>
vitis_analyzer xclbin.run_summary
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="building-an-application-with-c-and-rtl-based-kernels">
<h2>Building an Application with C++ and RTL-Based Kernels<a class="headerlink" href="#building-an-application-with-c-and-rtl-based-kernels" title="Permalink to this heading">¶</a></h2>
<p>Now that you have successfully built and run an application with a C++ based kernel, update the application to include an RTL-based kernel.</p>
<p>Similar to the previous section, you will build, emulate, and review the generated Application Timeline. Regardless of how the kernels were designed, after the kernel has been built, the host code accesses the kernels through similar function calls.</p>
<div class="section" id="rtl-based-kernel">
<h3>RTL-Based Kernel<a class="headerlink" href="#rtl-based-kernel" title="Permalink to this heading">¶</a></h3>
<p>First, you will create and package an RTL-based kernel using the RTL Kernel Wizard. By default, the wizard creates a kernel to increment by one. This kernel will be used in this tutorial. Additionally, the wizard automates the steps needed to package the RTL design into a kernel object file (XO).</p>
<p>You will generate the RTL-based kernel by quickly going through the RTL Kernel Wizard steps (at a high-level). Review the <a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/tree/master/Hardware_Accelerators/Feature_Tutorials/01-rtl_kernel_workflow">Getting Started with RTL Kernels</a> tutorial for more information. For complete details refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2020_1/vitis_doc/devrtlkernel.html#qnk1504034323350">RTL Kernels</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
<div class="section" id="create-the-vitis-project">
<h4>Create the Vitis Project<a class="headerlink" href="#create-the-vitis-project" title="Permalink to this heading">¶</a></h4>
<ol class="simple">
<li><p>To open the Vitis IDE, enter <code class="docutils literal notranslate"><span class="pre">vitis</span></code> in the command line.</p></li>
<li><p>Select <strong>./mixing-c-rtl-kernels/workspace</strong> as the workspace directory, and click <strong>Launch</strong>.</p></li>
<li><p>From the <code class="docutils literal notranslate"><span class="pre">Welcome</span></code> screen select <strong>Create Application Project</strong> to open the <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Project</span></code> wizard.</p></li>
<li><p>The first page displays a summary of the process. Click <strong>Next</strong> to proceed.</p></li>
<li><p>From the <code class="docutils literal notranslate"><span class="pre">Platform</span></code> page select the <strong>xilinx_u200_xdma_201830_2</strong> platform and click <strong>Next</strong>.</p></li>
<li><p>From the <code class="docutils literal notranslate"><span class="pre">Application</span> <span class="pre">Project</span> <span class="pre">Details</span></code> page, name your project <code class="docutils literal notranslate"><span class="pre">rtl_project</span></code> and click <strong>Next</strong>.</p></li>
<li><p>Under SW Acceleration Templates, select <strong>Empty Application</strong>, and click <strong>Finish</strong>. This creates a Vitis IDE project.</p></li>
</ol>
<p>Next, generate an RTL-based kernel from within the Vitis IDE.</p>
<ol class="simple">
<li><p>Select the menu command <strong>Xilinx &gt; Launch RTL Kernel Wizard &gt; rtl_project_kernels</strong>.  This opens the RTL Kernel Wizard Welcome page.</p></li>
<li><p>The first page is a summary of the process. Review it and click <strong>Next</strong>.</p></li>
<li><p>In the General Settings dialog box, keep all the default settings, and click <strong>Next</strong>.</p></li>
<li><p>In the Scalars dialog box, set the number of scalar arguments to <code class="docutils literal notranslate"><span class="pre">0</span></code>, and click <strong>Next</strong>.</p></li>
<li><p>In the Global Memory dialog box, keep all the default settings, and click <strong>Next</strong>.</p></li>
<li><p>In the Streaming Interfaces dialog box, keep all the default settings, and click <strong>Next</strong>.<br />The Summary dialog box is displayed and provides a summary of the RTL kernel settings and includes a function prototype which conveys what a kernel call would look like as a C function.</p></li>
<li><p>Click <strong>OK</strong>.</p></li>
</ol>
<p>The RTL Kernel source files have now been created.</p>
</div>
<div class="section" id="the-vivado-design-suite-project">
<h4>The Vivado Design Suite Project<a class="headerlink" href="#the-vivado-design-suite-project" title="Permalink to this heading">¶</a></h4>
<p>At this point, the Vivado Design Suite opens a project automatically with the generated RTL code corresponding to the default <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">=</span> <span class="pre">A</span> <span class="pre">+</span> <span class="pre">1</span></code> function.  You can navigate to review the source files or even run RTL simulation.  However, for this tutorial, you will not be modifying the default RTL Kernel and will only package into an object file (<code class="docutils literal notranslate"><span class="pre">.xo</span></code>).</p>
<ol>
<li><p>In Flow Navigator, click <strong>Generate RTL Kernel</strong>.<br /><img alt="Generate RTL Kernel" src="../../../../_images/mixing-c-rtl-kernels_flow_navigator.png" /></p></li>
<li><p>In the <strong>Generate RTL Kernel</strong> dialog box, select the <strong>Sources-only</strong> packaging option.</p></li>
<li><p>For <strong>Software Emulation Sources</strong>, you can add a C++ model of the RTL kernel, which is used for Software Emulation.</p>
<p>The C++ model must be coded by the design engineer. Typically, there is no C++ model available, and Hardware Emulation is used to test the design. Because the RTL Wizard creates a C++ model of the vadd design, the steps to add this file are also provided below.</p>
</li>
<li><p>Click the <strong>Browse</strong> command (<code class="docutils literal notranslate"><span class="pre">...</span></code>).</p></li>
<li><p>Double-click the <code class="docutils literal notranslate"><span class="pre">imports</span></code> directory.</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">rtl_kernel_wizard_0_cmodel.cpp</span></code> file and click <strong>OK</strong>.</p></li>
<li><p>To generate the RTL kernel, click <strong>OK</strong>.</p></li>
<li><p>After the RTL kernel has been generated successfully, click <strong>Yes</strong> to exit the Vivado Design Suite, and return to the Vitis IDE.</p></li>
<li><p>A message window displays some information related to the generated RTL kernel. Review it and click <strong>OK</strong>.</p></li>
<li><p>Exit the Vitis IDE.</p></li>
</ol>
<p>At this point, you have packaged the RTL kernel into the following object file, <code class="docutils literal notranslate"><span class="pre">rtl_kernel_wizard_0.xo</span></code> found in the following directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="mi">02</span><span class="o">-</span><span class="n">mixing</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="n">rtl</span><span class="o">-</span><span class="n">kernels</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">rtl_project_kernels</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">vitis_rtl_kernel</span><span class="o">/</span><span class="n">rtl_kernel_wizard_0</span>
</pre></div>
</div>
</div>
<div class="section" id="host-code-updates">
<h4>Host Code Updates<a class="headerlink" href="#host-code-updates" title="Permalink to this heading">¶</a></h4>
<p>To access the RTL-based kernel, the host code needs to be updated. The updates have been done in the <code class="docutils literal notranslate"><span class="pre">host_step2.cpp</span></code> file located in the following directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">reference</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">host</span><span class="o">/</span>
</pre></div>
</div>
<p>The updates includes additional OpenCL API calls briefly described below. The additional OpenCL API calls are identical to the ones used for the C++ based kernel with the arguments changed for the RTL-based kernel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="p">::</span><span class="n">Program</span><span class="p">::</span><span class="n">Binaries</span> <span class="n">bins</span><span class="p">;</span>
<span class="n">bins</span><span class="o">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">buf</span><span class="p">,</span><span class="n">nb</span><span class="p">});</span>
<span class="n">cl</span><span class="p">::</span><span class="n">Program</span> <span class="n">program</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">bins</span><span class="p">);</span>
</pre></div>
</div>
<p>The following code gets the <code class="docutils literal notranslate"><span class="pre">rtl_kernel_wizard_0</span></code> object from the program and assigns the name <em>krnl_const_add</em> on line 198. The <code class="docutils literal notranslate"><span class="pre">rtl_kernel_wizard_0</span></code> object name matches the name of the kernel you generated with the RTL Wizard.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="p">::</span><span class="n">Kernel</span> <span class="n">krnl_const_add</span><span class="p">(</span><span class="n">program</span><span class="p">,</span><span class="s2">&quot;rtl_kernel_wizard_0&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Next, define the krnl_const_add kernel arguments on line 219.</p>
<blockquote>
<div><p><strong>NOTE:</strong> In the host code, the buffer <code class="docutils literal notranslate"><span class="pre">buffer_result</span></code> is passed directly from the C kernel to the RTL kernel through DDR without being moved back to the host memory.</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krnl_const_add</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buffer_result</span><span class="p">);</span>
</pre></div>
</div>
<p>Launch the krnl_const_add kernel on line 222.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">krnl_const_add</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="build-and-emulation-with-c-and-rtl-based-kernels">
<h4>Build and Emulation with C++ and RTL Based Kernels<a class="headerlink" href="#build-and-emulation-with-c-and-rtl-based-kernels" title="Permalink to this heading">¶</a></h4>
<p>With the RTL-based kernel added and host code updated, build the application, targeting hardware emulation through the updated makefile in the <code class="docutils literal notranslate"><span class="pre">run2</span></code> directory. The makefile has been updated to add both the CPP and RTL-based kernels to the hardware platform file (<code class="docutils literal notranslate"><span class="pre">xclbin</span></code>).</p>
<ol>
<li><p>Navigate to the <code class="docutils literal notranslate"><span class="pre">./02-mixing-c-rtl-kernels/reference-files/run2</span></code> directory.</p></li>
<li><p>To build the application targeting hardware emulation, run the following makefile from the <code class="docutils literal notranslate"><span class="pre">./reference-files/run2</span></code> directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make all <span class="nv">TARGET</span><span class="o">=</span>hw_emu
</pre></div>
</div>
<p>As before, run emulation, and generate and review the Application Timeline by running the following commands from within the <code class="docutils literal notranslate"><span class="pre">run2</span></code> directory.</p>
</li>
<li><p>Set XCL_EMULATION_MODE environment variable for hardware emulation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span>hw_emu
</pre></div>
</div>
</li>
<li><p>Run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">host</span> <span class="n">krnl_vadd</span><span class="o">.</span><span class="n">hw_emu</span><span class="o">.</span><span class="n">xilinx_u200_xdma_201830_2</span><span class="o">.</span><span class="n">xclbin</span>
</pre></div>
</div>
</li>
<li><p>View the <strong>Application Timeline</strong> report in the Vitis analyzer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_analyzer</span> <span class="n">krnl_vadd</span><span class="o">.</span><span class="n">hw_emu</span><span class="o">.</span><span class="n">xilinx_u200_xdma_201830_2</span><span class="o">.</span><span class="n">xclbin</span><span class="o">.</span><span class="n">run_summary</span>
</pre></div>
</div>
</li>
<li><p>Under <strong>Device</strong>&gt;<strong>Binary Container</strong>, traverse along the timeline and zoom in.<br />You will now see both CUs, krnl_vadd_1 and rtl_kernel_wizard_0_1, show as <em>running</em>.<br /><img alt="Application Timeline 2" src="../../../../_images/mixing-c-rtl-kernels_timeline_two_kernels_vitis.PNG" /></p></li>
<li><p>After reviewing, close the Application Timeline, and exit Vitis analyzer.</p></li>
</ol>
<p>Vitis core development kit applications can use any combination of kernels, regardless of the language they were developed in.</p>
<p>Because a CPP emulation file was packaged with the RTL Kernel (through the RTL Wizard), you can also run software emulation.  To run software emulation, you can use the following steps:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the application</span>
make all <span class="nv">TARGET</span><span class="o">=</span>sw_emu

<span class="c1"># Set XCL_EMULATION_MODE environment variable for software emulation</span>
<span class="nb">export</span> <span class="nv">XCL_EMULATION_MODE</span><span class="o">=</span>sw_emu

<span class="c1"># Run software emulation</span>
./host krnl_vadd.sw_emu.xilinx_u200_xdma_201830_2.xclbin

<span class="c1"># Open Vitis analyzer and view the timeline waveform</span>
vitis_analyzer xclbin.run_summary
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this heading">¶</a></h2>
<p>With the understanding that Vitis compiler can use kernels from a variety of build sources, perhaps you would be interested in seeing some special designs implemented using the Vitis application acceleration development flow. If so, proceed to <a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/tree/master/Hardware_Accelerators/Design_Tutorials">Hardware Accelerator Design Tutorials</a>.</p>
</br>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/README.md">Return to Main Page</a></b></p>
<p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../01-rtl_kernel_workflow/README.html" class="btn btn-neutral float-left" title="Getting Started with RTL Kernels" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../03-dataflow_debug_and_optimization/README.html" class="btn btn-neutral float-right" title="Vitis HLS Analysis and Optimization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on August 5, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>