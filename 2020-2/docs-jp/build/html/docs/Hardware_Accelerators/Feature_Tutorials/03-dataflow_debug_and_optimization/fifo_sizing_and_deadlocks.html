<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>FIFO Sizing for Performance and avoiding Deadlocks &mdash; Vitis™ Tutorials 2020.2 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../../../../index.html" class="icon icon-home"> Vitis™ Tutorials
            <img src="../../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2020.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/README.html">Master</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis/README.html">Vitis Flow 101 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis_HLS/README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Accelerators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction/README.html">Introduction to Vitis Hardware Accelerators Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/02-bloom/README.html">Optimizing Accelerated FPGA Applications: Bloom Filter Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/01-convolution-tutorial/README.html">Accelerating Video Convolution Filtering Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/03-rtl_stream_kernel_integration/README.html">Mixed Kernels Design Tutorial with AXI Stream and Vitis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/04-traveling-salesperson/README.html">The Travelling Salesman Problem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Design_Tutorials/05-bottom_up_rtl_kernel/README.html">Bottom-up RTL Kernel Flow with Vitis for Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-rtl_kernel_workflow/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02-mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime and System Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/01-host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/02-ivas-ml/README.html">IVAS ZCU104 ML Acceleration Reference Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/01-mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/02-using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/03-controlling-vivado-implementation/README.html">Controlling Vivado Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/04-using-hbm/README.html">Using HBM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vitis Platform Creation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/01-Overview/README.html">Platform Creation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/02-Edge-AI-ZCU104/README.html">Vitis Custom Embedded Platform Creation Example on ZCU104</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/03_Edge_VCK190/README.html">Versal Custom Platform Creation Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/">Main</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Vitis™ Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>FIFO Sizing for Performance and avoiding Deadlocks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/Hardware_Accelerators/Feature_Tutorials/03-dataflow_debug_and_optimization/fifo_sizing_and_deadlocks.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table>
 <tr>
   <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>2020.2 Vitis™ Application Acceleration Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2020.2 Vitis Application Acceleration Development Flow Tutorials</a>
  </td>
 </tr>
 <tr>
 <td align="center"><h1>Vitis HLS Analysis and Optimization</h1>
 </td>
 </tr>
</table><div class="section" id="fifo-sizing-for-performance-and-avoiding-deadlocks">
<h1>FIFO Sizing for Performance and avoiding Deadlocks<a class="headerlink" href="#fifo-sizing-for-performance-and-avoiding-deadlocks" title="Permalink to this heading">¶</a></h1>
<p>Due to the dynamic nature of the dataflow optimization, and the propensity of different parallel tasks to execute at different rates, it is possible that poorly sized dataflow channels can cause loss of performance and/or deadlock. There are different types of dataflow channels - some are created by the user while some are created by the tool.</p>
<div class="section" id="types-of-channels">
<h2>Types of channels<a class="headerlink" href="#types-of-channels" title="Permalink to this heading">¶</a></h2>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Channel Type</th>
<th align="left">Examples</th>
<th align="center">Created By</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">FIFO</td>
<td align="left">Streams (including hls::streams and streamed arrays)</td>
<td align="center">User</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">Scalar propagation FIFOs</td>
<td align="center">Tool</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">Streams of blocks</td>
<td align="center">User</td>
</tr>
</tbody>
</table><p>These FIFO channels should be thought of as “channels with their own handshake”, because:</p>
<ul class="simple">
<li><p>Their read and write operations are scheduled,</p></li>
<li><p>Their read/write signals are driven individually by the pipeline control or the FSM</p></li>
<li><p>Their full_n/empty_n signals directly stall individual iterations of a pipeline or states of the FSM.</p></li>
</ul>
<table border="1" class="docutils">
<thead>
<tr>
<th align="center">Channel Type</th>
<th>Examples</th>
<th align="center">Created By</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">PIPO</td>
<td>PIPO</td>
<td align="center">User</td>
</tr>
<tr>
<td align="center"></td>
<td>Task Level FIFOs (TLF)</td>
<td align="center">Tool</td>
</tr>
<tr>
<td align="center"></td>
<td>Input and output ports to the upper level</td>
<td align="center">User</td>
</tr>
</tbody>
</table><p>Task Level FIFOs (TLF) are scalar FIFOs which are connected to the done handshake of the producer for writing, and to the start handshake of the consumer for reading. These types of FIFOs are inferred automatically by the tool. They are considered PIPO-like because of the underlying synchronization mechanism.</p>
<p>These channels should be thought of as “channels that use ap_ctrl_chain handshake”, because:</p>
<ul class="simple">
<li><p>Their write and read operations are not scheduled. They are implicitly associated with the “done” handshake or the “start” handshake of a process</p></li>
<li><p>Their write and read signals are connected to ap_done and ap_ready respectively</p></li>
<li><p>Their full_n and empty_n are connected to ap_continue and ap_start respectively</p></li>
</ul>
<p>What really matters with respect to the analysis of depth, performance, deadlocks etc., is whether:</p>
<ul class="simple">
<li><p>Channels have their own handshake (FIFOs). Hence their accesses are <em>spread</em> throughout the execution of their process. For example, you can read a FIFO outside the first II of a pipeline, or even in the last process of a dataflow network.</p></li>
<li><p>Channels are hand-shaken via ap_ctrl_chain (PIPOs). Hence their reads must be in the first initiation interval (II) of the pipeline or in processes that are in the first “level” of a dataflow network, and similarly their writes must be in the last II or in the last “level.”</p></li>
<li><p>The other difference is based on the amount of data that is being transferred in one operation is more relevant for resource analysis than for performance: array for PIPOs and streams of blocks, scalar for streams, scalar propagation FIFOs and task level FIFOs.</p></li>
</ul>
</div>
<div class="section" id="deadlock-detection-and-analysis">
<h2>Deadlock Detection and Analysis<a class="headerlink" href="#deadlock-detection-and-analysis" title="Permalink to this heading">¶</a></h2>
<p>Insufficiently sized FIFOs (and PIPOs) in dataflow can cause deadlocks. Consider the following diagram:
<img alt="Dataflow FIFO Channels" src="../../../../_images/dataflow_fifo_channels.png" /></p>
<ul class="simple">
<li><p>Case 1:</p>
<ul>
<li><p>Producer alternately writes to FIFO1, FIFO2, FIFO1, FIFO2, and so on.</p></li>
<li><p>Consumer alternately reads from FIFO1, FIFO2, FIFO1, FIFO2, and so on.</p></li>
<li><p>A depth of 1 for both FIFOs is enough to avoid deadlocks (and the default depth of 2 optimizes for performance).</p></li>
</ul>
</li>
<li><p>Case 2 (same structure):</p>
<ul>
<li><p>Producer writes to FIFO1 for N times, then to FIFO2 for N times</p></li>
<li><p>Consumer alternately reads from FIFO1, FIFO2, FIFO1, FIFO2, and so on.</p></li>
<li><p>A depth of N is necessary for FIFO1 (and the default depth of 2 for FIFO2 is optimal for performance)</p></li>
</ul>
</li>
</ul>
<p>As you can see from the above two simple cases, for exactly the same structure of code, depending on how the FIFO channels are accessed, the FIFO depths may need to be set differently. FIFO depths are used to amortize and match the <em>burst behavior</em> of FIFO accesses.</p>
<p>Compiler-created FIFOs and PIPOs (from scalars or arrays between processes) should never cause deadlocks. But their depths might be insufficient for optimal performance. User created FIFOs (from hls::streams and hls::stream_of_blocks between processes) may cause both deadlocks and/or low performance depending on their depths.</p>
<blockquote>
<div><p><strong>TIP:</strong> Deadlocks due to insufficient FIFO depths always exhibit at least one blocked writer. If not, it is most likely a design issue - typically due to non-blocking reads or writes, or reads and writes conditioned by empty() and full().</p>
</div></blockquote>
<p>The goal of this tutorial is to help you analyze a dataflow design and identify its bottlenecks, which may be:</p>
<ol class="simple">
<li><p>Processes or regions which have a larger II than the rest, and thus can constrain the overall throughput. This issue can be fixed by:</p>
<ul class="simple">
<li><p>Reducing the II for such processes</p></li>
<li><p>Investigating dataflow regions and to “dig” inside them to discover the reason (which may be any one of these three).</p></li>
</ul>
</li>
<li><p>FIFOs (channels with their own handshake: which includes streams, streams of blocks, streamed arrays) or PIPOs (channels without their own handshake: includes PIPOs and TLFs) that have a depth that is too small, and thus can become full. This issue can be fixed by increasing the depth of the channel. A following section will describe how to do this.</p></li>
<li><p>Top-level synchronization (scalar or external memory inputs from above or outputs to the calling context, synchronized via ap_ctrl_chain or ap_ctrl_hs of the region). In this case the remedy is to manually copy these variables and pass them through the network of processes to avoid the loss of performance.</p></li>
</ol>
<p>Note that for complex designs, with data-dependent synchronizations (e.g. a process reads 128 times from a FIFO in one execution, and 32 times in another), a process may block for a variety of reasons, that change over time. In this case, the Dataflow co-simulation waveforms may be the only viable approach for debugging - as described in the earlier lab.</p>
<p>As the second exercise in this tutorial, you will first synthesize the example design and bring up the dataflow viewer to show how a deadlock can be investigated and resolved. In this lab, you will look at a simple <a class="reference external" href="./reference-files/src/deadlock/example.cpp">deadlock example</a>, found in the <code class="docutils literal notranslate"><span class="pre">reference-files/deadlock</span></code> folder.</p>
<p>In this lab, you will:</p>
<ol class="simple">
<li><p>Understand how to use the different features of the dataflow viewer to investigate a deadlock.</p></li>
<li><p>Use the FIFO sizing features to resolve the deadlock and improve performance.</p></li>
</ol>
</div>
<div class="section" id="second-lab">
<h2>Second Lab<a class="headerlink" href="#second-lab" title="Permalink to this heading">¶</a></h2>
<ol class="simple">
<li><p>Change directory to the <code class="docutils literal notranslate"><span class="pre">03-dataflow_debug_and_optimization/reference-files/deadlock</span></code> directory, and launch the Vitis HLS tool by issuing the following command:</p></li>
</ol>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span>
</pre></div>
</div>
<p>The Vitis HLS GUI will launch and create the project needed to synthesize the design but the GUI will stop short of executing the commands in the <code class="docutils literal notranslate"><span class="pre">script.tcl</span></code> file.</p>
<ul class="simple">
<li><p>Click the dropdown menu next to the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) and select <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span></code> (as shown below) and click <code class="docutils literal notranslate"><span class="pre">OK</span></code> in the <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span> <span class="pre">Dialog</span></code> box to run simulation.</p></li>
</ul>
<p><img alt="C Simulation" src="../../../../_images/c_sim.png" /></p>
<ul class="simple">
<li><p>Click on the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) to synthesize the design.</p></li>
<li><p>Click the dropdown menu next to the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) and select  <code class="docutils literal notranslate"><span class="pre">Co-simulation</span></code> link and then select the <code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> option before clicking <code class="docutils literal notranslate"><span class="pre">OK</span></code> in the window that pops up to run the C/RTL cosimulation. The GUI will automatically launch the Dataflow Viewer as a deadlock is detected in this design (as shown in the following figure).</p></li>
</ul>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/dataflow_deadlock_view.png" /></p>
<ul class="simple">
<li><p>Click on the green <code class="docutils literal notranslate"><span class="pre">+</span></code> command in the Dataflow Graph toolbar menu to expand all channels and sub-processes in the design. Processes that are deadlocked will be shown in red in the graph (as shown below). Channels that are full are displayed with red arrows in the graph, and channels that are empty are displayed with white arrows in the graph. The Channel table will additionally highlight the depth of full or empty channels in red.</p></li>
<li><p>Using both the <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> column and the <code class="docutils literal notranslate"><span class="pre">Depth</span></code> column, you can see that the first channel that you must resize is the <strong>data_channel1</strong> that is between producer <strong>proc_1_1_U0</strong> and consumer <strong>proc_1_2_U0</strong> processes (as shown in the <code class="docutils literal notranslate"><span class="pre">Producer</span></code> and <code class="docutils literal notranslate"><span class="pre">Consumer</span></code> columns).</p></li>
</ul>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/dataflow_deadlock_view2.png" /></p>
<p>There are three ways to do this FIFO sizing, and this lab will walk through each one in turn:</p>
<ul class="simple">
<li><p>Manual FIFO sizing</p></li>
<li><p>Global FIFO sizing</p></li>
<li><p>Automated FIFO sizing</p></li>
</ul>
<div class="section" id="manual-fifo-sizing">
<h3>Manual FIFO Sizing<a class="headerlink" href="#manual-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>Performance losses due to insufficient FIFO or PIPO depth always cause at least one process to block on a full FIFO. Determining the right size for the FIFO depth is generally an unsolvable problem. Fortunately, RTL co-simulation also reports the maximum depth achieved for each channel so that even if you assign an arbitrarily large depth for the FIFO, you can always resize it to the max depth achieved. Additionally, increasing FIFO or PIPO depths never reduces performance, it simply consumes additional resources.</p>
<p><img alt="Adjusting FIFO Depth 1." src="../../../../_images/adjusting_fifo_depth.png" /></p>
<p>As discussed, you must resize <strong>data_channel1</strong> that is between producer <strong>proc_1_1_U0</strong> and consumer <strong>proc_1_2_U0</strong> processes. In order to resize the blocked FIFO, follow these steps:</p>
<ul class="simple">
<li><p>As the above figure shows, right-click on the highlighted <strong>data_channel1</strong> row and select the <code class="docutils literal notranslate"><span class="pre">Modify</span> <span class="pre">Depth</span></code> option. This displays the <strong>Modify Depth</strong> dialog box as shown below.</p></li>
</ul>
<p><img alt="Modifying FIFO Depth" src="../../../../_images/modify_depth.png" /></p>
<ul class="simple">
<li><p>Set the new depth as 4 (double of 2) and click the <code class="docutils literal notranslate"><span class="pre">OK</span></code> button.</p></li>
<li><p>The GUI will ask you if you want to rerun the cosimulation. Click the <code class="docutils literal notranslate"><span class="pre">No</span></code> button as we are not done with modifying FIFO depths.</p></li>
<li><p>Repeat this for <strong>data_channel2</strong> which was also part of the deadlock.</p></li>
<li><p>The GUI will ask you if you want to rerun the cosimulation. Click the <code class="docutils literal notranslate"><span class="pre">Yes</span></code> button, and then select the <code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> option before clicking <code class="docutils literal notranslate"><span class="pre">OK</span></code> to launch co-simulation.</p></li>
<li><p>The C/RTL co-simulation is run again and reports that the design is still deadlocked (as shown below)</p></li>
</ul>
<p><img alt="Adjusting FIFO Depth 2." src="../../../../_images/adjusting_fifo_depth2.png" /></p>
<ul class="simple">
<li><p>Now repeat the above steps and increase the depth of <strong>data_channel1</strong> and <strong>data_channel2</strong> to 10. Rerun C/RTL co-simulation and observe that the deadlock is no longer on these channels (now highlighted in green) but has now moved to the channels between process <strong>proc_1_U0</strong> and <strong>proc_2_U0</strong> (as shown below).</p></li>
</ul>
<p><img alt="Adjusting FIFO Depth 3." src="../../../../_images/adjusting_fifo_depth3.png" /></p>
<ul class="simple">
<li><p>Repeat the FIFO resizing steps on these channels and set the new depth to 10 and then rerun the C/RTL co-simulation. Notice that the deadlock has now moved to channels between process <strong>proc_2_1_U0</strong> and <strong>proc_2_2_U0</strong> (as shown below).</p></li>
</ul>
<p><img alt="Adjusting FIFO Depth 4." src="../../../../_images/adjusting_fifo_depth4.png" /></p>
<ul class="simple">
<li><p>Repeat the FIFO resizing steps on these channels and set the new depth to 10 and then rerun the C/RTL co-simulation. Notice that the deadlock is now resolved (as shown below).</p></li>
</ul>
<p><strong>TIP:</strong> The Dataflow Graph may not be displayed automatically, because the deadlock issue has been resolved. You might have to manually open the Dataflow Graph viewer.</p>
<p><img alt="Adjusting FIFO Depth 5." src="../../../../_images/adjusting_fifo_depth5.png" /></p>
<p>In the above figure, note that only three of the channels actually require a depth of 10. This can be seen by comparing the <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> and <code class="docutils literal notranslate"><span class="pre">Depth</span></code> columns. The other channels are fine with the default depths and dont require the increased depth value.</p>
<p><strong>IMPORTANT:</strong> While the deadlock has been resolved the new FIFO depths that helped resolve the issue have not been back-annotated to the source code. If you quit the Vitis HLS GUI at this point, you will loose these depth settings. Note that if you do choose to back-annotate these new depths to the source code, you will have to undo them later when you proceed to the next phase of the tutorial.</p>
<ul class="simple">
<li><p>To back-annotate your solution to the source code, select all the channels that need the new depth setting (by pressing Ctrl and selecting the channel with a mouse click) and select the <code class="docutils literal notranslate"><span class="pre">Back</span> <span class="pre">Annotate</span> <span class="pre">the</span> <span class="pre">New</span> <span class="pre">Depth</span> <span class="pre">into</span> <span class="pre">the</span> <span class="pre">Design</span></code> option as shown below and click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</p></li>
</ul>
<p><img alt="Back Annotate" src="../../../../_images/back_annotate.png" />
<img alt="Back Annotate" src="../../../../_images/back_annotate0.png" /></p>
<ul class="simple">
<li><p>A new window will pop up and show the change in the form of a pragma that will be inserted in the design’s source code. Note that this new pragma setting will contain a comment stating that this pragma was inserted by Vitis HLS (as shown below).</p></li>
</ul>
<p><img alt="Back Annotate" src="../../../../_images/back_annotate1.png" /></p>
<p>After each such back-annotation step, the GUI will ask if you want to resynthesize the design (since new pragmas have been added). Click <code class="docutils literal notranslate"><span class="pre">Yes</span></code> to resynthesize the design. Next, click the dropdown menu next to the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) and select  <code class="docutils literal notranslate"><span class="pre">Co-simulation</span></code> link and then select the <code class="docutils literal notranslate"><span class="pre">Channel</span> <span class="pre">(PIPO/FIFO)</span> <span class="pre">Profiling</span></code> option before clicking <code class="docutils literal notranslate"><span class="pre">OK</span></code> in the window that pops up to run the C/RTL cosimulation. Confirm that the new pragma settings resolve the deadlock.</p>
<p><strong>IMPORTANT</strong>: Before proceeding to the next step in the tutorial, it is important to undo the above annotation step. Double click on <code class="docutils literal notranslate"><span class="pre">example.cpp</span></code> in the <code class="docutils literal notranslate"><span class="pre">Explorer</span></code> tab (as shown below) and select the <code class="docutils literal notranslate"><span class="pre">Directives</span></code> tab on the far right. This tab will show the new pragmas that were added in the last step. Right click on each pragma and select <code class="docutils literal notranslate"><span class="pre">Remove</span> <span class="pre">Directive</span></code> to remove it from the source file.</p>
<p><img alt="Back Annotate" src="../../../../_images/remove_directive.png" /></p>
</div>
<div class="section" id="global-fifo-sizing">
<h3>Global FIFO Sizing<a class="headerlink" href="#global-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>In order to use the Global FIFO sizing flow, it will require you to restart from the beginning. Exit the Vitis HLS GUI and restart it by executing the following at the command line:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span>
</pre></div>
</div>
<p>Next follow these steps:</p>
<ol class="simple">
<li><p>Click on the drop down arrow next to the green run icon <img alt="Run Icon" src="../../../../_images/run_icon.png" /> and select <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">Simulation</span></code> and then click <code class="docutils literal notranslate"><span class="pre">OK</span></code> in the popped up window.</p></li>
<li><p>Verify that csim completes successfully and without warnings</p>
<ul class="simple">
<li><p>Watch for and write down the maximum depth of any hls::stream printed out by the C simulator to the console, e.g.</p></li>
</ul>
</li>
</ol>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="n">reached</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">26</span><span class="w"> </span><span class="n">hls</span><span class="o">::</span><span class="n">stream</span><span class="p">()</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">design</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span>
</pre></div>
</div>
<ol>
<li><p>Force the depth of all FIFOs to be the max value reported by C simulation. You can do this by clicking the <code class="docutils literal notranslate"><span class="pre">Solution</span></code> link in the top menu and selecting <code class="docutils literal notranslate"><span class="pre">Solution</span> <span class="pre">Settings</span></code> (as shown below)</p>
<p><img alt="Solution Settings" src="../../../../_images/solution_settings.png" /></p>
</li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">Solution</span> <span class="pre">Settings</span></code> window, under <code class="docutils literal notranslate"><span class="pre">General</span></code>, scroll to find <code class="docutils literal notranslate"><span class="pre">config_dataflow</span></code> in the Configuration Settings (as shown below), select the <code class="docutils literal notranslate"><span class="pre">override_user_fifo_depth</span></code> setting and set the value to 40. Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> to set this new configuration setting.</p>
<p><img alt="Global Settings" src="../../../../_images/global_setting1.png" /></p>
</li>
<li><p>Click on the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) to rerun C Synthesis.</p></li>
<li><p>Rerun C/RTL Cosimulation by selecting <code class="docutils literal notranslate"><span class="pre">Co-Simulation</span></code> from the drop down menu next to the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />). Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> in the window that pops open.</p></li>
<li><p>This time, no deadlock will be observed and C/RTL co-simulation finishes without error.</p></li>
<li><p>Go to the <code class="docutils literal notranslate"><span class="pre">Co-simulation</span> <span class="pre">Report</span></code> and right click on the top function that has the dataflow icon next to it and select <code class="docutils literal notranslate"><span class="pre">Open</span> <span class="pre">Dataflow</span> <span class="pre">Viewer</span></code> to relaunch the Dataflow viewer.</p></li>
<li><p>Now look at the channel table in the Dataflow viewer and compare the depths in the <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> and <code class="docutils literal notranslate"><span class="pre">Depth</span></code> columns. The correct depths can be observed in the <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> column (as seen below). This is the needed depths for all the FIFOs in this design.</p>
<p><img alt="Global Settings" src="../../../../_images/global_setting.png" /></p>
</li>
<li><p>You can now manually back-annotate the observed <code class="docutils literal notranslate"><span class="pre">Cosim</span> <span class="pre">Max</span> <span class="pre">Depth</span></code> as pragma settings in the source code.</p></li>
</ol>
</div>
<div class="section" id="automated-fifo-sizing">
<h3>Automated FIFO Sizing<a class="headerlink" href="#automated-fifo-sizing" title="Permalink to this heading">¶</a></h3>
<p>Of the three approaches, the automatic FIFO sizing is the easiest but:</p>
<ul class="simple">
<li><p>It requires repeated cosimulation runs and so may take a while to converge.</p></li>
<li><p>It is a heuristic algorithm, and in some cases it may never converge.</p></li>
</ul>
<p>The algorithm automatically increases the depth of FIFOs that block writers until performance no longer increases. It may increase some FIFO depths beyond what is reasonable and will require user inspection.</p>
<p>In order to use the Automated FIFO sizing flow, it will require you to restart from the beginning. Exit the Vitis HLS GUI and restart it by executing the following at the command line:</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">vitis_hls</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">script</span><span class="p">.</span><span class="n">tcl</span><span class="w"></span>
</pre></div>
</div>
<p>Next follow these steps:</p>
<p>To turn on the automated FIFO sizing:</p>
<ol>
<li><p>Click on the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />) to rerun C Synthesis.</p></li>
<li><p>Run C/RTL Co-simulation by selecting <code class="docutils literal notranslate"><span class="pre">Co-Simulation</span></code> from the dropdown menu next to the green <strong>Run</strong> command (<img alt="Run Icon" src="../../../../_images/run_icon.png" />).</p></li>
<li><p>Select the <code class="docutils literal notranslate"><span class="pre">Dynamic</span> <span class="pre">Deadlock</span> <span class="pre">Prevention</span></code> option in the <code class="docutils literal notranslate"><span class="pre">Co-simulation</span> <span class="pre">Dialog</span></code> (as shown below). Click <code class="docutils literal notranslate"><span class="pre">OK</span></code> to start the C/RTL co-simulation.</p>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/auto_fifo_setting.png" /></p>
</li>
<li><p>The C/RTL Co-simulation will run for a while attempting to find the right FIFO sizes for the channels that cause the deadlock. After some time, it will stop when the co-simulation successfully completes.</p></li>
<li><p>Relaunch the Dataflow Viewer to see a new <code class="docutils literal notranslate"><span class="pre">FIFO</span> <span class="pre">Sizing</span></code> table along side the Process and Channel tables. This new tables documents the new FIFO sizes determined by the algorithm.</p></li>
<li><p>You can manually back-annotate these FIFO sizes in the source code using pragmas or directives.</p></li>
</ol>
<p><img alt="Dataflow Deadlock View" src="../../../../_images/auto_fifo_sizing.png" /></p>
</div>
</div>
<div class="section" id="takeaways">
<h2>Takeaways<a class="headerlink" href="#takeaways" title="Permalink to this heading">¶</a></h2>
<p>In summary, the Dataflow viewer enables the following throughput analysis tasks:</p>
<ul class="simple">
<li><p>The graph shows the overall topology of the DATAFLOW region and shows what type of channels (FIFO/PIPO) were inferred for communication between the tasks in the DATAFLOW region. Analyzing each channel and process can be useful to resolve issues such as deadlock or poor throughput because of bad FIFO sizing.</p></li>
<li><p>The co-simulation data helps with the FIFO sizing problem by tracking the maximum size of the FIFO during the course of the simulation and thereby giving the user a good reference point on how to size the FIFOs. In addition, when running cosimulation, automatic deadlock detection can highlight the processes and channels involved in the deadlock allowing the user to quickly narrow the focus and fix the issue.</p></li>
<li><p>In addition to FIFO sizing, the data reported after cosimulation also provides, on a per process and channel basis, the time spent stalling either waiting for input or blocked from writing output. The graph helps the user understand such issues and manage how the channels are sized to accommodate slow producers versus fast consumers and/or vice-versa. In addition, the graph is useful in understanding how reading from the input in the middle of a DATAFLOW region can impact performance. This is a fairly common scenario where performance can be impacted.</p></li>
</ul>
</br>
<hr/>
<p align="center"><b><a href="/docs/vitis-getting-started/">Return to Getting Started Pathway</a> — <a href="./README.md">Return to Start of Tutorial</a></b></p><p align="center"><sup>Copyright&copy; 2021 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on August 5, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>