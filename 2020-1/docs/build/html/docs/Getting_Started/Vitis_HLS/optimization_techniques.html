<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>3. Using Optimization Techniques &mdash; Vitis™ Tutorials 2022.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../../../README.html" class="icon icon-home"> Vitis™ Tutorials
            <img src="../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/README.html">Master</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Vitis/README.html">Vitis Flow 101 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Accelerators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware_Accelerators/Design_Tutorials/02-bloom/README.html">Optimizing Accelerated FPGA Applications: Bloom Filter Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware_Accelerators/Design_Tutorials/01-convolution-tutorial/README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware_Accelerators/Design_Tutorials/03-rtl_stream_kernel_integration/README.html">Mixed Kernels Design Tutorial with AXI Stream and Vitis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware_Accelerators/Feature_Tutorials/01-rtl_kernel_workflow/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware_Accelerators/Feature_Tutorials/02-mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime and System Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Runtime_and_System_Optimization/Design_Tutorials/01-host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Runtime_and_System_Optimization/Design_Tutorials/02-ivas-ml/README.html">IVAS ZCU104 ML Acceleration Reference Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Runtime_and_System_Optimization/Feature_Tutorials/01-mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Runtime_and_System_Optimization/Feature_Tutorials/02-using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Runtime_and_System_Optimization/Feature_Tutorials/03-controlling-vivado-implementation/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vitis Platform Creation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Vitis_Platform_Creation/Introduction/01-Overview/README.html">Platform Creation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Vitis_Platform_Creation/Introduction/02-Edge-AI-ZCU104/README.html">Vitis Custom Embedded Platform Creation Example on ZCU104</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/">Main</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../README.html">Vitis™ Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../README.html" class="icon icon-home"></a> &raquo;</li>
      <li>3. Using Optimization Techniques</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/docs/Getting_Started/Vitis_HLS/optimization_techniques.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
  </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="using-optimization-techniques">
<h1>3. Using Optimization Techniques<a class="headerlink" href="#using-optimization-techniques" title="Permalink to this heading">¶</a></h1>
<p>This lab discusses various optimization techniques that you can try to reconcile the II violation from the <a class="reference internal" href="synth_and_analysis.html"><span class="doc">Running Simulation and Synthesis</span></a> lab.</p>
<div class="section" id="configure-the-pipeline-loops-threshold">
<h2>Configure the Pipeline Loops Threshold<a class="headerlink" href="#configure-the-pipeline-loops-threshold" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><p><strong>IMPORTANT</strong>: Remember, the violation is reported as a result of the tool trying to pipeline the small loops in the design. If you disable the automatic pipelining of the loops, the tool will no longer report a violation.</p>
</div></blockquote>
<p>Review the Synthesis Summary report; you will see that the two II violations occur in loops with 64 and 8 iterations (tripcount) respectively. Setting <strong>config_compile</strong> to <code class="docutils literal notranslate"><span class="pre">6</span></code> should eliminate these loops from the optimization.</p>
<ol>
<li><p>In the Explorer view, right-click the project solution, or <code class="docutils literal notranslate"><span class="pre">solution1</span></code>, and select <strong>Solution Settings</strong>.
This opens the Solution Settings dialog box.</p></li>
<li><p>Select the <strong>General</strong> setting, and click <strong>Add</strong> to add the new setting.</p></li>
<li><p>In the Add Command dialog box, make the following selections:</p>
<ol>
<li><p>For Command, select <strong>config_compile</strong>.</p></li>
<li><p>For pipeline_loops, enter <code class="docutils literal notranslate"><span class="pre">6</span></code>. This indicates that the tool should only automatically pipeline loops with six or fewer iterations.</p>
<p><img alt="Config Compile" src="../../../_images/config_compile.png" /></p>
</li>
</ol>
</li>
<li><p>Click <strong>OK</strong>. You are returned to the Solution Settings dialog box.</p></li>
<li><p>Click <strong>OK</strong>  to add the <code class="docutils literal notranslate"><span class="pre">config_compile</span></code> command to limit the automatic loop pipelining as specified.</p></li>
<li><p>From the toolbar, click <strong>C Synthesis</strong>  to rerun the synthesis command and display the results.</p>
<p>This configuration appears to reduce the II violation from four cycles to two cycles. It has not completely resolved the problem.</p>
<p>This configuration might be an acceptable response to the II violation when the loops are not in the critical path of the design, or they represent a small problem relative to some larger problems that must be resolved. In other words, not all violations need to be resolved, and in some cases, not all violations can be resolved. They are simply artifacts of performance.</p>
<p><img alt="Config Compile" src="../../../_images/config_compile-synth-results.png" /></p>
<blockquote>
<div><p><strong>TIP</strong>: Back out the change before proceeding, right-click on the solution. Select <strong>Solution Settings</strong> command, and remove the config_compile command you just added.</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="configure-pipeline-latency">
<h2>Configure Pipeline Latency<a class="headerlink" href="#configure-pipeline-latency" title="Permalink to this heading">¶</a></h2>
<p>Another possible optimization solution is to tell the tool that the latency of four or two clock cycles is acceptable performance. This eliminates the warning because the latency would match your specification. The overall latency of the application indicates that perhaps II=4 for these loops is not really a problem.</p>
<p>In the last section, the <strong>config_compile</strong> command is a tool configuration command that affects the compilation of the whole design. This optimization is a code directive to apply to a specific portion of the source code rather than to the tool itself.</p>
<ol>
<li><p>Open the Source Code Editor for the function.</p>
<p>This can be done from the Explorer view by expanding the <code class="docutils literal notranslate"><span class="pre">Source</span></code> folder for the project, and double-clicking on the <code class="docutils literal notranslate"><span class="pre">dct.cpp</span></code> file to open it.</p>
<p>With the Source Code Editor open, the right hand of the IDE also displays the Outline and Directive views for your code.</p>
<ul class="simple">
<li><p><strong>Outline view</strong>: Displays an outline of the open source code file for quick navigation of the code.</p></li>
<li><p><strong>Directives view</strong>: Select operations or elements of your code to assign <code class="docutils literal notranslate"><span class="pre">HLS</span> <span class="pre">pragmas</span></code> to your source code, or to assign <code class="docutils literal notranslate"><span class="pre">set_directive</span></code> commands to a Tcl script that is associated with the active solution. For more information, refer to <a class="reference external" href="ttps://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=optimizinghlsproject.html%3Ba=gip1583519972576">Adding Pragmas and Directives</a> in the Vitis HLS FLow of the Vitis Unified Software Platform Documentation (UG1416).</p></li>
</ul>
</li>
<li><p>In the Directives view, in the <code class="docutils literal notranslate"><span class="pre">dct_2d</span></code> function hierarchy, right-click <strong>Col_DCT_Loop</strong>, and select <strong>Insert Directive</strong>.</p>
<p>The Vitis HLS Directive Editor is displayed.</p>
<p><img alt="Pipeline Pragma" src="../../../_images/pipeline-pragma.png" /></p>
</li>
<li><p>For Directive, select the <strong>Pipeline</strong> directive.</p></li>
<li><p>For Destination, select <strong>Directive File</strong>.
This is the default.</p>
<p>Directives let you create different solutions, with different directive files to optimize performance in different ways, and find the best solution. With HLS pragmas added directly into the source file, all solutions have the same optimizations.</p>
<p>However, late in your design process it is worth changing the settled optimizations from the directive file to the HLS pragmas in your C/C++ code, so the optimizations become part of your code. You will do this later in this tutorial.</p>
</li>
<li><p>In the II field, enter <code class="docutils literal notranslate"><span class="pre">4</span></code>. This should accept the current performance, and eliminate the II violation.</p></li>
<li><p>Click <strong>OK</strong> to apply the directive.
The HLS PIPELINE II=4 added to the Directive view.</p></li>
<li><p>Click <strong>C Synthesis</strong> to rerun synthesis.</p>
<p>The II violation for the specified operation is no longer reported. Notice the Interval column still reads 4. It is no longer not reported as a problem.</p>
<p><img alt="Pipeline Defined II" src="../../../_images/pipeline-defined-ii.png" /></p>
</li>
</ol>
<blockquote>
<div><p><strong>TIP</strong>: Back out the change before proceeding. Select the source code tab to make it active and display the Directive view. Right-click <strong>HLS PIPELINE II=4</strong> and select <strong>Remove Directive</strong>. Rerun synthesis.</p>
</div></blockquote>
</div>
<div class="section" id="assign-dual-port-rams-with-bind-storage">
<h2>Assign Dual-Port RAMs with BIND_STORAGE<a class="headerlink" href="#assign-dual-port-rams-with-bind-storage" title="Permalink to this heading">¶</a></h2>
<p>Examine the DRC Warning messages in the DRCs view. The message <code class="docutils literal notranslate"><span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">schedule</span> <span class="pre">load</span> <span class="pre">operation...</span></code> indicates a load/load (or read/read conflict) issue with memory transactions. In this case rather than accepting the latency, you are going to try to optimize the implementation to achieve the best performance (II=1).</p>
<p>The specific problem of reading or writing to memory can possibly be addressed by increasing the available memory ports to read from, or write to. One approach is to use the BIND_STORAGE pragma or directive to specify the type of device resource to use in implementing the storage. BIND_STORAGE defines a specific device resource for use in implementing a storage structure associated with a variable in the RTL. For more information, refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2020_1/vitis_doc/hlsoptimizationdirectives.html#vcb1584808314102">BIND_STORAGE</a> in the Vitis HLS Flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
<p><img alt="BIND_STORAGE" src="../../../_images/bind_storage_pragma.png" /></p>
<ol>
<li><p>Select the <strong>dct.cpp</strong> tab to make the Code Editor active.</p></li>
<li><p>In the Directives view, right-click on the <code class="docutils literal notranslate"><span class="pre">col_inbuf</span></code> variable in the <code class="docutils literal notranslate"><span class="pre">dct_2d</span></code> function, and select <strong>Add Directive</strong>.</p>
<p>This displays the Vitis HLS Directive Editor.</p>
</li>
<li><p>For Directive, select <strong>BIND_STORAGE</strong>.</p></li>
<li><p>For Destination, select <strong>Directive File</strong>.</p></li>
<li><p>In <strong>Options</strong>, the variable you selected is listed. Specify the type of memory to use for the variable as dual-port RAM (<code class="docutils literal notranslate"><span class="pre">ram_2p</span></code>).</p>
<p>You can optionally specify the implementation and the latency. Leave them blank for now.</p>
</li>
<li><p>Click <strong>OK</strong>.</p></li>
<li><p>Repeat the process for the the <code class="docutils literal notranslate"><span class="pre">buf_2d_out</span></code> variable of the top-level <code class="docutils literal notranslate"><span class="pre">dct</span></code> function.</p>
<ol class="simple">
<li><p>In the Directive view, select the <code class="docutils literal notranslate"><span class="pre">buf_2d_out</span></code> variable and add the <strong>BIND_STORAGE</strong> pragma to specify the dual-port RAM (<code class="docutils literal notranslate"><span class="pre">ram_2p</span></code>).</p></li>
</ol>
</li>
<li><p>Click <strong>Run C Synthesis</strong> to rerun synthesis to see the results.</p>
<p>The results show that the to help resolve the II violation was not resolved. It looks like more than two ports are needed to be able to achieve an II of 1.</p>
</li>
</ol>
<blockquote>
<div><p><strong>TIP:</strong> Back out the change before proceeding. Select the Source Code tab to make it active and display the Directive view. Right-click on <strong>HLS BIND_STORAGE</strong> pragmas and select <strong>Remove Directive</strong>. Rerun synthesis if needed.</p>
</div></blockquote>
</div>
<div class="section" id="assign-an-array-partition">
<h2>Assign an Array Partition<a class="headerlink" href="#assign-an-array-partition" title="Permalink to this heading">¶</a></h2>
<p>Another approach to solve the memory port conflict for the pipelined loop iterations, is to use the ARRAY_PARTITION directive to reconfigure the structure of the array.</p>
<p>ARRAY_PARTITION lets you partition an array into smaller arrays or into individual registers instead of one large array. This effectively either increases the amount of read and write ports for the storage or removes the memory entirely, and can potentially improves the throughput of the design. However, ARRAY_PARTITION also requires more memory instances or registers, and so increases area and resource consumption. For more information, refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2020_1/vitis_doc/hlsoptimizationdirectives.html#xoa1585343027355">ARRAY_PARTITION</a> in the Vitis HLS Flow of the Vitis Unified Software Platform Documentation (UG1416). If partitioning large arrays, this can also increase the compile time.</p>
<ol>
<li><p>In the Directives view, select the array variables, <strong>col_inbuf</strong> and <strong>buf_2d_out</strong>  from the associated II violations.</p></li>
<li><p>Right-click and select <strong>Add Directive</strong>.</p>
<p>This opens the Vitis HLS Directive Editor as shown in the following figure.</p>
<p><img alt="ARRAY_PARTITION" src="../../../_images/array_partition_pragma.png" /></p>
</li>
<li><p>In the Vitis HLS Directive Editor, make the following selections:</p>
<ol class="simple">
<li><p>For Directive,  select <strong>ARRAY_PARTITION</strong>.</p></li>
<li><p>For Destination, select <strong>Directive File</strong>.</p></li>
<li><p>In  Options, the variable you previously selected should be listed.
1.Leave the dimension set to 1, the default value.</p></li>
<li><p>Specify a factor of <strong>8</strong>.</p></li>
<li><p>Select <strong>cyclic</strong> for the type.</p></li>
</ol>
</li>
<li><p>Click <strong>OK</strong> to close the form, and apply the directive.</p></li>
<li><p>Repeat the steps above for the <code class="docutils literal notranslate"><span class="pre">buf_2d_out</span></code> variable.</p></li>
<li><p>Click <strong>C Synthesis</strong> to rerun the synthesis to see the results.</p>
<p>The results show that this optimization resolves the II violation, as shown in the following figure, while preserving the loop pipeline and performance improvements.</p>
</li>
<li><p>Re-examine the Synthesis Summary report to see the details of your synthesized design.</p>
<p><img alt="Synthesis Report" src="../../../_images/dct_synthesis_report-array_partition.png" /></p>
<p>The reason for choosing a cyclic partition with a factor of 8 has to do with the code structures involved. The loop is processing an 8x8 matrix, which requires taking eight passes through the outer loop, and eight passes through the inner loop. By selecting a cyclic array partition, with a factor of 8, you are creating eight separate arrays that each get read one time per iteration. This eliminates any contention for accessing the memory during the pipeline of the loop.</p>
</li>
</ol>
</div>
<div class="section" id="next-step">
<h2>Next Step<a class="headerlink" href="#next-step" title="Permalink to this heading">¶</a></h2>
<p>Now that you have resolved the optimizations for the specific issues in the design, there is one more optimization. You will be <a class="reference internal" href="dataflow_design.html"><span class="doc">using the DATAFLOW optimization</span></a>.
</br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/README.md">Return to Main Page</a> — <a href="./README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on May 16, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>