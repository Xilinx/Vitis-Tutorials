<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>5. Optimizing with Dataflow &mdash; Vitis™ Tutorials 2020.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../../../../README.html" class="icon icon-home"> Vitis™ Tutorials
            <img src="../../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2020.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/README.html">Master</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis/README.html">Vitis Flow 101 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis_HLS/README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Accelerators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02-bloom/README.html">Optimizing Accelerated FPGA Applications: Bloom Filter Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03-rtl_stream_kernel_integration/README.html">Mixed Kernels Design Tutorial with AXI Stream and Vitis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Feature_Tutorials/01-rtl_kernel_workflow/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Feature_Tutorials/02-mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime and System Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/01-host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/02-ivas-ml/README.html">IVAS ZCU104 ML Acceleration Reference Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/01-mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/02-using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/03-controlling-vivado-implementation/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vitis Platform Creation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/01-Overview/README.html">Platform Creation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/02-Edge-AI-ZCU104/README.html">Vitis Custom Embedded Platform Creation Example on ZCU104</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/">Main</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2021-2/build/html/index.html">2021.2</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2021-1/build/html/index.html">2021.1</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/build/html/index.html">2020.2</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../README.html">Vitis™ Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../README.html" class="icon icon-home"></a> &raquo;</li>
      <li>5. Optimizing with Dataflow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/Hardware_Accelerators/Design_Tutorials/01-convolution-tutorial/dataflow.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="optimizing-with-dataflow">
<h1>5. Optimizing with Dataflow<a class="headerlink" href="#optimizing-with-dataflow" title="Permalink to this heading">¶</a></h1>
<p>In the last lab, you improved the efficiency of the kernel by using fixed point data types. In this lab, you will look at the structure of your code to increase task and instruction level parallelism. Pipelining is a common technique used by most processors to parallelize at the instruction level. Pipelining allows the processor to simultaneously process multiple instructions at the same time by executing them on hardware that has finished the previous instruction.</p>
<p>The Vitis™ compiler automatically pipelines most operations. You do not need to add anything to enable pipelining in your code. You can look at how each of the loops have been pipelined in the HLS report.</p>
<p>While pipelining usually works at the instruction level, the Vitis compiler can also pipeline at the function level using a transformation called “dataflow”. Dataflow allows you to pipeline multiple functions so that you can execute their instructions simultaneously on different sets of iterations. The following figure shows an example.</p>
<p><img alt="../../../../_images/dataflow.png" src="../../../../_images/dataflow.png" /></p>
<p>Without using dataflow, <code class="docutils literal notranslate"><span class="pre">func_A</span></code>, <code class="docutils literal notranslate"><span class="pre">func_B</span></code>, and <code class="docutils literal notranslate"><span class="pre">func_C</span></code> are executed sequentially. With dataflow enabled, the three functions can overlap, which will reduce the total execution time.</p>
<blockquote>
<div><p><strong>TIP</strong>: This lab relates to <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html%3Ba=vhk1551127460562">Step 1: Partition the Code into a Load-Compute-Store Pattern</a> in the <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html">Methodology for Accelerating Applications with the Vitis Unified Software Platform</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
</div></blockquote>
<p>In this lab, to implement the functions in dataflow, you first divide the original convolution function into three separate functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">read_dataflow</span></code>: Read the data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code>: Compute the convolution for a particular line.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write_dataflow</span></code>: Write the output to the main memory.</p></li>
</ul>
<p>The three functions will use streams to pass data between them. To understand streams, refer <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=hlsstreamlib.html%3Ba=mes1539734221433">HLS Stream Library</a> in the Vitis HLS flow in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416). Streams allow you to process data at the data element level. Using streams, the next module can immediately start processing the element as soon as it is inserted into the stream variable.</p>
<div class="section" id="kernel-code-modifications">
<h2>Kernel Code Modifications<a class="headerlink" href="#kernel-code-modifications" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><p><strong>TIP:</strong> The completed kernel source file is provided under the <code class="docutils literal notranslate"><span class="pre">reference-files/dataflow</span></code> folder. You can use it as a reference if needed.</p>
</div></blockquote>
<ol>
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code> file from <code class="docutils literal notranslate"><span class="pre">src/dataflow</span></code>.</p></li>
<li><p>First, navigate to the <code class="docutils literal notranslate"><span class="pre">convolve_fpga</span></code> function, which is the top-level function in the kernel. Modify the structure of this function to call the three sub-functions as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">convolve_fpga</span><span class="p">(</span><span class="n">const</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">RGBPixel</span><span class="o">*</span> <span class="n">outFrame</span><span class="p">,</span>
                   <span class="n">const</span> <span class="nb">float</span><span class="o">*</span> <span class="n">coefficient</span><span class="p">,</span> <span class="nb">int</span> <span class="n">coefficient_size</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">img_height</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">half</span> <span class="o">=</span> <span class="n">COEFFICIENT_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

  <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">read_stream</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">);</span>
  <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;</span> <span class="n">write_stream</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">);</span>
  <span class="nb">int</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">img_height</span><span class="p">;</span>

<span class="c1">#pragma HLS dataflow</span>
  <span class="n">read_dataflow</span><span class="p">(</span><span class="n">read_stream</span><span class="p">,</span> <span class="n">inFrame</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
  <span class="n">compute_dataflow</span><span class="p">(</span><span class="n">write_stream</span><span class="p">,</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">img_width</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
  <span class="n">write_dataflow</span><span class="p">(</span><span class="n">outFrame</span><span class="p">,</span> <span class="n">write_stream</span><span class="p">,</span> <span class="n">elements</span><span class="p">);</span>  
<span class="p">}</span>  
</pre></div>
</div>
<p>Notice that the three sub-functions are called, and the data is passed by the stream type objects <code class="docutils literal notranslate"><span class="pre">read_stream</span></code> and <code class="docutils literal notranslate"><span class="pre">write_stream</span></code>. Those streams are implemented using FIFOs on the FPGA. The DATAFLOW pragma is used so that the three functions will be executed in parallel. To understand how dataflow pragma works, refer to <em>Vivado Design Suite User Guide High-Level Synthesis</em> (<a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=latest%3Bd=ug902-vivado-high-level-synthesis.pdf">UG902</a>).</p>
</li>
<li><p>Next, you create the three sub-functions one by one. First, start with the <code class="docutils literal notranslate"><span class="pre">read_dataflow</span></code> function.</p>
<p>This function is created for reading data from global memory, and it passes the data to the next function using streams. To make sure that you do not read data out-of-bounds, zeros are inserted into the streams to add the padding pixels at the bottom of the image. When the line index is less than the image_height, read a line from the input image, and store it in the read_stream stream.</p>
<p>The completed function should be similar to the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">read_dataflow</span><span class="p">(</span><span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">read_stream</span><span class="p">,</span> <span class="n">const</span> <span class="n">RGBPixel</span> <span class="o">*</span><span class="ow">in</span><span class="p">,</span>
                   <span class="nb">int</span> <span class="n">img_width</span><span class="p">,</span> <span class="nb">int</span> <span class="n">elements</span><span class="p">,</span> <span class="nb">int</span> <span class="n">half</span><span class="p">)</span> <span class="p">{</span>
<span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">read_stream</span> <span class="o">&lt;&lt;</span>  <span class="ow">in</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span>
<span class="nb">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">half</span> <span class="o">+</span> <span class="n">COEFFICIENT_SIZE</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">read_stream</span> <span class="o">&lt;&lt;</span> <span class="n">zero</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The hls::stream objects are defined in the <code class="docutils literal notranslate"><span class="pre">hls_stream.h</span></code> header. The <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operator is used to insert values into a stream.</p>
</li>
<li><p>Now, work on the <code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code> function. This is the most complicated function because it will read in the streaming data from <code class="docutils literal notranslate"><span class="pre">read_flow</span></code> function and compute it. The output data will be written to the <code class="docutils literal notranslate"><span class="pre">write_stream</span></code>.</p>
<p>The code snippet for <code class="docutils literal notranslate"><span class="pre">compute_dataflow</span></code> is as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void compute_dataflow(hls::stream&lt;RGBPixel&gt;&amp; write_stream, hls::stream&lt;RGBPixel&gt;&amp; read_stream,
                      const float* coefficient, int img_width, int elements, int center) {
static RGBPixel window_mem[COEFFICIENT_SIZE][MAX_WIDTH];
#pragma HLS data_pack variable=window_mem
#pragma HLS array_partition variable=window_mem complete dim=1
static fixed coef[COEFFICIENT_SIZE * COEFFICIENT_SIZE];
#pragma HLS array_partition variable=coef complete

    for(int i  = 0; i &lt; COEFFICIENT_SIZE*COEFFICIENT_SIZE; i++) {
        coef[i] = coefficient[i];
    }

    int line_idx = 0;
    while(line_idx &lt; center) {
        for(int i = 0; i &lt; img_width; i++) {
            window_mem[line_idx][i] = zero;
        }
        line_idx++;
    }

    while(line_idx &lt; COEFFICIENT_SIZE - 1) {
        for(int ii = 0; ii &lt; img_width; ii++) {
            read_stream &gt;&gt; window_mem[line_idx][ii];
        }
        line_idx++;
    }

    for(int ii = 0; ii &lt; COEFFICIENT_SIZE; ii++) {
        read_stream &gt;&gt; window_mem[line_idx][ii];
    }

    int top_idx = 0;
    int insert_idx = line_idx;
    int window_line_idx = top_idx;
    int j = 0;
    int insert_column_idx = COEFFICIENT_SIZE;
    while(elements--) {
        fixed sum_r = 0, sum_g=0, sum_b=0;
        for(int m = 0; m &lt; COEFFICIENT_SIZE; ++m) {
            for(int n = 0; n &lt; COEFFICIENT_SIZE; ++n) {
                int jj = j + n - center;
                RGBPixel tmp = (jj &gt;= 0 &amp;&amp; jj &lt; img_width) ? window_mem[window_line_idx][jj] : zero;
                fixed coef_tmp = coef[m * COEFFICIENT_SIZE + n] * (jj &gt;= 0 &amp;&amp; jj &lt; img_width);
                sum_r += tmp.r * coef_tmp;
                sum_g += tmp.g * coef_tmp;
                sum_b += tmp.b * coef_tmp;
            }
            window_line_idx = ((window_line_idx + 1) == COEFFICIENT_SIZE) ? 0 : window_line_idx + 1;
        }
        window_line_idx = top_idx;
        RGBPixel out = {sum_r.to_int(), sum_g.to_int(), sum_b.to_int(), 0};
        write_stream &lt;&lt; out;
        j++;
        if(j &gt;= img_width) {
            j = 0;
            top_idx = ((top_idx + 1) == COEFFICIENT_SIZE) ? 0 : top_idx + 1;
            window_line_idx = top_idx;
        }
        read_stream &gt;&gt; window_mem[insert_idx][insert_column_idx++];
        if (insert_column_idx &gt;= img_width) {
            insert_column_idx = 0;
            insert_idx = ((insert_idx + 1) == COEFFICIENT_SIZE) ? 0 : insert_idx + 1;
        }
    }
}
</pre></div>
</div>
<p>A local buffer <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> is defined to store the necessary lines of data for computing. <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code> operator is used to extract elements from stream. The first few lines of the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> array should be zeroed out because these represent the padding of the image. This will only be done on the first iteration.</p>
<p>The computation is implemented in the main loop, and the loop is pipelined because the COEFFICIENT_SIZE variable is predefined at the compile time. For more details about optimizing loops, refer to <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/ndoc?v=2020.1%3Bt=https:%3Bd=methodologyacceleratingapplications.html%3Ba=wnz1555544738414">Step 4: Improve Loop Latencies</a> in <a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=2020.1%3Bt=vitis+doc%3Bd=methodologyacceleratingapplications.html">Methodology for Accelerating Applications with the Vitis Unified Software Platform</a> in the Application Acceleration Development flow of the Vitis Unified Software Platform Documentation (UG1416).</p>
<p>After computation, the <code class="docutils literal notranslate"><span class="pre">out</span></code> value is pushed to a <code class="docutils literal notranslate"><span class="pre">write_stream</span></code> for the downstream function to process.</p>
</li>
<li><p>Now, look at the <code class="docutils literal notranslate"><span class="pre">write_dataflow</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">write_dataflow</span><span class="p">(</span><span class="n">RGBPixel</span><span class="o">*</span> <span class="n">outFrame</span><span class="p">,</span> <span class="n">hls</span><span class="p">::</span><span class="n">stream</span><span class="o">&lt;</span><span class="n">RGBPixel</span><span class="o">&gt;&amp;</span> <span class="n">write_stream</span><span class="p">,</span>
                    <span class="nb">int</span> <span class="n">elements</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">elements</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">write_stream</span> <span class="o">&gt;&gt;</span> <span class="n">outFrame</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function is quite simple. It just outputs the streaming results to the global memory.</p>
</li>
</ol>
</div>
<div class="section" id="run-hardware-emulation-for-dataflow">
<h2>Run Hardware Emulation for Dataflow<a class="headerlink" href="#run-hardware-emulation-for-dataflow" title="Permalink to this heading">¶</a></h2>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">makefile</span></code> directory and use the following command to run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">dataflow</span> <span class="n">SOLUTION</span><span class="o">=</span><span class="mi">1</span> <span class="n">NUM_FRAMES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>You should see the following results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processed</span> <span class="mf">0.02</span> <span class="n">MB</span> <span class="ow">in</span> <span class="mf">29.728</span><span class="n">s</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">MBps</span><span class="p">)</span>

<span class="n">INFO</span><span class="p">:</span> <span class="p">[</span><span class="n">Vitis</span><span class="o">-</span><span class="n">EM</span> <span class="mi">22</span><span class="p">]</span> <span class="p">[</span><span class="n">Wall</span> <span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">23</span><span class="p">:</span><span class="mi">03</span><span class="p">,</span> <span class="n">Emulation</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.108257</span> <span class="n">ms</span><span class="p">]</span> <span class="n">Data</span> <span class="n">transfer</span> <span class="n">between</span> <span class="n">kernel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="k">global</span> <span class="n">memory</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem3</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
</pre></div>
</div>
</div>
<div class="section" id="view-the-profile-summary-report-for-hardware-emulation">
<h2>View the Profile Summary Report for Hardware Emulation<a class="headerlink" href="#view-the-profile-summary-report-for-hardware-emulation" title="Permalink to this heading">¶</a></h2>
<p>Use the following command to view the Profile Summary report.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">view_run_summary</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">dataflow</span>
</pre></div>
</div>
<p>The kernel execution time is now reduced to 0.059 ms.</p>
<p>Here is the updated table.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="left">Step</th>
<th align="left">Image Size</th>
<th align="right">Time (HW-EM)(ms)</th>
<th align="right">Reads(KB)</th>
<th align="right">Writes(KB)</th>
<th align="right">Avg. Read (KB)</th>
<th align="right">Avg. Write (KB)</th>
<th align="right">Bandwidth (MBps)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">baseline</td>
<td align="left">512x10</td>
<td align="right">3.903</td>
<td align="right">344</td>
<td align="right">20.0</td>
<td align="right">0.004</td>
<td align="right">0.004</td>
<td align="right">5.2</td>
</tr>
<tr>
<td align="left">localbuf</td>
<td align="left">512x10</td>
<td align="right">1.574 (2.48x)</td>
<td align="right">21  (0.12x)</td>
<td align="right">20.0</td>
<td align="right">0.064</td>
<td align="right">0.064</td>
<td align="right">13</td>
</tr>
<tr>
<td align="left">fixed-point data</td>
<td align="left">512x10</td>
<td align="right">0.46 (3.4x)</td>
<td align="right">21</td>
<td align="right">20.0</td>
<td align="right">0.064</td>
<td align="right">0.064</td>
<td align="right">44</td>
</tr>
<tr>
<td align="left">dataflow</td>
<td align="left">512x10</td>
<td align="right">0.059 (7.8x)</td>
<td align="right">21</td>
<td align="right">20.0</td>
<td align="right">0.064</td>
<td align="right">0.064</td>
<td align="right">347</td>
</tr>
</tbody>
</table></div>
<div class="section" id="next-step">
<h2>Next Step<a class="headerlink" href="#next-step" title="Permalink to this heading">¶</a></h2>
<p>You have performed a couple of optimizations on the hardware kernels to improve the performance. In the next section, you look at different host code optimizations, such as <a class="reference internal" href="multi-CU.html"><span class="doc">using out-of-order queues and multiple compute units</span></a>.</p>
<p></br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/README.md">Return to Getting Started Pathway</a> — <a href="/docs/convolution-tutorial/README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on August 23, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>