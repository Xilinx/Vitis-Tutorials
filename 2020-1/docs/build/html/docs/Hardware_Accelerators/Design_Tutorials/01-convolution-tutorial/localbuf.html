<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<!-- OneTrust Cookies Consent Notice start for xilinx.github.io -->

<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="03af8d57-0a04-47a6-8f10-322fa00d8fc7" ></script>
<script type="text/javascript">
function OptanonWrapper() { }
</script>
<!-- OneTrust Cookies Consent Notice end for xilinx.github.io -->
  <title>3. Optimizing Memory Transfers &mdash; Vitis™ Tutorials 2022.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
            <a href="../../../../README.html" class="icon icon-home"> Vitis™ Tutorials
            <img src="../../../../_static/xilinx-header-logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2022.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">日本語版</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs-jp/README.html">Master</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started Pathway</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis/README.html">Vitis Flow 101 Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Getting_Started/Vitis_HLS/README.html">Vitis HLS Analysis and Optimization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware Accelerators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../02-bloom/README.html">Optimizing Accelerated FPGA Applications: Bloom Filter Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html">Optimizing Accelerated FPGA Applications: Convolution Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03-rtl_stream_kernel_integration/README.html">Mixed Kernels Design Tutorial with AXI Stream and Vitis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Feature_Tutorials/01-rtl_kernel_workflow/README.html">Getting Started with RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Feature_Tutorials/02-mixing-c-rtl-kernels/README.html">Mixing C++ and RTL Kernels</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Runtime and System Optimization</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/01-host-code-opt/README.html">Host Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Design_Tutorials/02-ivas-ml/README.html">IVAS ZCU104 ML Acceleration Reference Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/01-mult-ddr-banks/README.html">Using Multiple DDR Banks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/02-using-multiple-cu/README.html">Using Multiple Compute Units</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Runtime_and_System_Optimization/Feature_Tutorials/03-controlling-vivado-implementation/README.html">Controlling Vivado Implementation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vitis Platform Creation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/01-Overview/README.html">Platform Creation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Vitis_Platform_Creation/Introduction/02-Edge-AI-ZCU104/README.html">Vitis Custom Embedded Platform Creation Example on ZCU104</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/">Main</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: black" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../README.html">Vitis™ Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../README.html" class="icon icon-home"></a> &raquo;</li>
      <li>3. Optimizing Memory Transfers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/docs/Hardware_Accelerators/Design_Tutorials/01-convolution-tutorial/localbuf.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <table class="sphinxhide">
 <tr>
   <td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/><h1>2020.1 Vitis™ Application Acceleration Development Flow Tutorials</h1>
   <a href="https://github.com/Xilinx/Vitis-Tutorials/branches/all">See 2019.2 Vitis Application Acceleration Development Flow Tutorials</a>
   </td>
 </tr>
 <tr>
 <td>
 </td>
 </tr>
</table><div class="section" id="optimizing-memory-transfers">
<h1>3. Optimizing Memory Transfers<a class="headerlink" href="#optimizing-memory-transfers" title="Permalink to this heading">¶</a></h1>
<p>In the last lab, you established a baseline performance of the application using a single frame. In this lab, you remove redundant memory accesses, and optimize the data movement between the kernel and global memory.</p>
<p>For Hardware Emulation runs, the kernel is processing images with a size of 512x10. Each pixel is composed of 4 bytes representing RGBA values. For a 512x10 image, that means that you are processing 20 KB per frame. The processed report also indicates that application reads (167.781+167.781=335.562) KBs of data in your kernel. This is significantly more than the 20 KB input frame. This is because you are reading all the filter coefficients every time you process a pixel, as well as 9 pixels to make a computation. In steady state, 8 of the 9 pixels for processing have already been read.</p>
<p>This might not be a problem on modern CPUs because most processors have a hardware controlled cache that store the data automatically on a very fast local cache. However, on an FPGA, this needs to be done explicitly by creating and copying the data into a local array in the hardware kernel.</p>
<p>You can apply the same technique to read a part of the image to the local array and perform the convolution on that local data instead of on the global memory. You will read in as many lines as the width of the filter. You then perform the convolution on these lines and write the result of the line back to global memory. Afterwards, you are going to read only the next line into the next slot of the local memory to perform the next operation. The following diagram shows this process.</p>
<p><img alt="../../../../_images/convolve_fpga_local.png" src="../../../../_images/convolve_fpga_local.png" /></p>
<p>In the first operation, you read three lines into the local memory, and perform the operation on those lines. You store the result back to the global memory and read the next line in the fourth line of the local memory array. After you reach the end of the buffer, you circle back to the top of the local memory array and write there.</p>
<div class="section" id="kernel-code-modifications">
<h2>Kernel Code Modifications<a class="headerlink" href="#kernel-code-modifications" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><p><strong>TIP:</strong> The completed kernel source file is provided under the <code class="docutils literal notranslate"><span class="pre">reference-files/localbuf</span></code> folder. You can use it as a reference if needed.</p>
</div></blockquote>
<p>From the <code class="docutils literal notranslate"><span class="pre">src/localbuf</span></code> folder, open the <code class="docutils literal notranslate"><span class="pre">convolve_fpga.cpp</span></code> file, and make the following modifications:</p>
<ol>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">cstring</span></code> header at the top of the file to add the declaration of the <code class="docutils literal notranslate"><span class="pre">memcpy</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="c1">#include &lt;cstring&gt;</span>
</pre></div>
</div>
</li>
<li><p>After the last pragma in the function body, add the following.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">float</span> <span class="n">coef</span><span class="p">[</span><span class="n">MAX_FILTER</span> <span class="o">*</span> <span class="n">MAX_FILTER</span><span class="p">];</span>
 <span class="n">memcpy</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">coefficient_size</span> <span class="o">*</span> <span class="n">coefficient_size</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="nb">float</span><span class="p">));</span>
</pre></div>
</div>
<p>These lines create a <code class="docutils literal notranslate"><span class="pre">coef</span></code> array that will store the filter coefficients, then copy the data from the <code class="docutils literal notranslate"><span class="pre">coefficient</span></code> array passed into the function. The <code class="docutils literal notranslate"><span class="pre">coef</span></code> array is going to be synthesized on the FPGA using block RAM resources. Access to block RAM has significantly lower latency than the on-board DDR memory.</p>
</li>
<li><p>Now that you have created the cached array called <code class="docutils literal notranslate"><span class="pre">coef</span></code>, you need to modify the rest of the code to use that array.
Change the following lines in the inner loops (line 48-50):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">sum_r</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">coefficient</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="n">sum_g</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">coefficient</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="n">sum_b</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">coefficient</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">sum_r</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="n">sum_g</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="n">sum_b</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
</pre></div>
</div>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">MAX_FILTER</span></code> specifies the largest filter you expect your kernel to process. The <code class="docutils literal notranslate"><span class="pre">MAX_WIDTH</span></code> is the maximum width of the image that this kernel can process. These are set in the <code class="docutils literal notranslate"><span class="pre">constants.h</span></code> header and can be updated to handle larger sizes. In this example, the <code class="docutils literal notranslate"><span class="pre">MAX_FILTER</span></code> is 19, and the <code class="docutils literal notranslate"><span class="pre">MAX_WIDTH</span></code> is 1920. Create a local array for the input pixels and output pixels and only store <code class="docutils literal notranslate"><span class="pre">MAX_FILTER</span></code> lines because you need at least that many lines to perform the convolution at each iteration.
Put the following lines before the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop (after line 34).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">RGBPixel</span> <span class="n">window_mem</span><span class="p">[</span><span class="n">MAX_FILTER</span><span class="p">][</span><span class="n">MAX_WIDTH</span><span class="p">];</span>
 <span class="n">RGBPixel</span> <span class="n">out_line</span><span class="p">[</span><span class="n">MAX_WIDTH</span><span class="p">];</span>
 <span class="c1">#pragma HLS data_pack variable=window_mem</span>
 <span class="c1">#pragma HLS data_pack variable=out_line</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> variable stores the input pixels. The <code class="docutils literal notranslate"><span class="pre">out_line</span></code> variable stores the output pixels.</p>
</li>
<li><p>Next, fill the first half of the arrays with zero to take the border into account. Put the following lines after the lines you just added in the previous step.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">static</span> <span class="n">const</span> <span class="n">RGBPixel</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
 <span class="nb">int</span> <span class="n">center</span> <span class="o">=</span> <span class="n">coefficient_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
 <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">center</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pixel</span> <span class="o">&lt;</span> <span class="n">MAX_WIDTH</span><span class="p">;</span> <span class="n">pixel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">window_mem</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">pixel</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">center</span></code> is the location of the center pixel in the filter. It is the same as the radius of the kernel.</p>
</li>
<li><p>Fill the second half of the array with the first few lines of the image. You are going to let the next <code class="docutils literal notranslate"><span class="pre">for</span></code> loop bring in the final line.
Put the following lines of code after the lines from Step 5.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">line</span> <span class="o">=</span> <span class="n">center</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">coefficient_size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">memcpy</span><span class="p">(</span><span class="n">window_mem</span><span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">inFrame</span> <span class="o">+</span> <span class="p">((</span><span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">),</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RGBPixel</span><span class="p">));</span>
 <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>In the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop that iterates over the height of the image, first read the next line of the image into the local array. You also need to take into account the additional padding at the end of the image, so you need to add a check to see if you have reached the bottom of the image and insert zeros into the array. Modify the outer loop as follows (line 38).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">img_height</span><span class="p">;</span> <span class="o">++</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
     <span class="nb">int</span> <span class="n">next_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">coefficient_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_FILTER</span><span class="p">;</span>
     <span class="k">if</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">img_height</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">memcpy</span><span class="p">(</span><span class="n">window_mem</span><span class="p">[</span><span class="n">next_line</span><span class="p">],</span> <span class="n">inFrame</span> <span class="o">+</span> <span class="p">((</span><span class="n">line</span><span class="o">+</span><span class="n">center</span><span class="p">)</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">),</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RGBPixel</span><span class="p">));</span>
     <span class="p">}</span>
     <span class="k">else</span> <span class="p">{</span>
         <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pixel</span> <span class="o">&lt;</span> <span class="n">MAX_WIDTH</span><span class="p">;</span> <span class="n">pixel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">window_mem</span><span class="p">[</span><span class="n">next_line</span><span class="p">][</span><span class="n">pixel</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
     <span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">next_line</span></code> variable tracks where in the window you will be storing the next line of the input image.</p>
</li>
<li><p>You also need to track which lines of the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> you will read in your convolution. The calculation here uses the <code class="docutils literal notranslate"><span class="pre">window_line_idx</span></code> variable to map the input image line to the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> line in the local array. The <code class="docutils literal notranslate"><span class="pre">top_idx</span></code> variable will be used to point to the first line of the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> array. Put the following lines of code after the lines you just added in Step 7.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">int</span> <span class="n">window_line_idx</span> <span class="o">=</span> <span class="n">next_line</span> <span class="o">-</span> <span class="n">center</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
 <span class="k">if</span><span class="p">(</span><span class="n">window_line_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">window_line_idx</span> <span class="o">+=</span> <span class="n">MAX_FILTER</span><span class="p">;</span>
 <span class="nb">int</span> <span class="n">top_idx</span> <span class="o">=</span> <span class="n">window_line_idx</span><span class="p">;</span>
</pre></div>
</div>
<p><img alt="../../../../_images/convolve_variables.png" src="../../../../_images/convolve_variables.png" /></p>
</li>
<li><p>Next, modify the convolution operation to use the new <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> array, instead of the <code class="docutils literal notranslate"><span class="pre">inFrame</span></code> parameter. Replace the calculation of the inner loop (line 47~), from:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="n">center</span><span class="p">;</span>
 <span class="nb">int</span> <span class="n">jj</span> <span class="o">=</span> <span class="n">pixel</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">center</span><span class="p">;</span>

 <span class="k">if</span><span class="p">(</span><span class="n">ii</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">img_height</span> <span class="o">&amp;&amp;</span> <span class="n">jj</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">img_width</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">sum_r</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
     <span class="n">sum_g</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
     <span class="n">sum_b</span> <span class="o">+=</span> <span class="n">inFrame</span><span class="p">[(</span><span class="n">ii</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[(</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="nb">int</span> <span class="n">jj</span> <span class="o">=</span> <span class="n">pixel</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">center</span><span class="p">;</span>
 <span class="k">if</span><span class="p">(</span><span class="n">jj</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">jj</span> <span class="o">&lt;</span> <span class="n">img_width</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">sum_r</span> <span class="o">+=</span> <span class="n">window_mem</span><span class="p">[</span><span class="n">window_line_idx</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
     <span class="n">sum_g</span> <span class="o">+=</span> <span class="n">window_mem</span><span class="p">[</span><span class="n">window_line_idx</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
     <span class="n">sum_b</span> <span class="o">+=</span> <span class="n">window_mem</span><span class="p">[</span><span class="n">window_line_idx</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">coef</span><span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="n">coefficient_size</span> <span class="o">+</span> <span class="n">n</span><span class="p">];</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>Notice you are using the <code class="docutils literal notranslate"><span class="pre">window_line_idx</span></code> variable to index into the <code class="docutils literal notranslate"><span class="pre">window_mem</span></code> variable instead of <code class="docutils literal notranslate"><span class="pre">ii</span></code>.</p>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">window_line_idx</span></code> variable needs to be incremented each time you update the <code class="docutils literal notranslate"><span class="pre">m</span></code> variable. You also need to make sure that after you read the edge of the local array, you circle back to the first line. The following code that does this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>window_line_idx=(window_line_idx + 1) == MAX_FILTER ? 0 : window_line_idx + 1;
</pre></div>
</div>
<p>This is equivalent to <code class="docutils literal notranslate"><span class="pre">window_line_idx</span> <span class="pre">=</span> <span class="pre">(window_line_idx</span> <span class="pre">+</span> <span class="pre">1)</span> <span class="pre">%</span> <span class="pre">MAX_FILTER;</span></code>, but you are avoiding a modulus operation which is computationally expensive.</p>
<p>This will need to be placed at the end of the loop that updates the <code class="docutils literal notranslate"><span class="pre">m</span></code> variable.</p>
</li>
<li><p>After calculating the convolution for a given pixel, reset the <code class="docutils literal notranslate"><span class="pre">window_line_idx</span></code> variable to <code class="docutils literal notranslate"><span class="pre">top_idx</span></code>, and write your results to the <code class="docutils literal notranslate"><span class="pre">out_line</span></code> array. You can replace write to <code class="docutils literal notranslate"><span class="pre">outFrame</span></code> with write to <code class="docutils literal notranslate"><span class="pre">out_line</span></code>. Replace (line 58~60).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outFrame</span><span class="p">[</span><span class="n">line</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_r</span><span class="p">);</span>
<span class="n">outFrame</span><span class="p">[</span><span class="n">line</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_g</span><span class="p">);</span>
<span class="n">outFrame</span><span class="p">[</span><span class="n">line</span> <span class="o">*</span> <span class="n">img_width</span> <span class="o">+</span> <span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_b</span><span class="p">);</span>
</pre></div>
</div>
<p>with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">window_line_idx</span> <span class="o">=</span> <span class="n">top_idx</span><span class="p">;</span>
<span class="n">out_line</span><span class="p">[</span><span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span>  <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_r</span><span class="p">);</span>
<span class="n">out_line</span><span class="p">[</span><span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span>  <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_g</span><span class="p">);</span>
<span class="n">out_line</span><span class="p">[</span><span class="n">pixel</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span>  <span class="n">fabsf</span><span class="p">(</span><span class="n">sum_b</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">out_line</span></code> will be written to <code class="docutils literal notranslate"><span class="pre">outFrame</span></code> after the image line has been processed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">memcpy</span><span class="p">(</span><span class="n">outFrame</span><span class="o">+</span><span class="p">(</span><span class="n">line</span> <span class="o">*</span> <span class="n">img_width</span><span class="p">),</span> <span class="n">out_line</span><span class="p">,</span> <span class="n">img_width</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">RGBPixel</span><span class="p">));</span>
</pre></div>
</div>
<p>This will be placed after the for loop that iterates over <code class="docutils literal notranslate"><span class="pre">image_width</span></code>.</p>
</li>
</ol>
<p>Now you have completed all the modifications, and you can run hardware emulation with the optimized code.</p>
</div>
<div class="section" id="run-hardware-emulation">
<h2>Run Hardware Emulation<a class="headerlink" href="#run-hardware-emulation" title="Permalink to this heading">¶</a></h2>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> directory, and use the following command to run hardware emulation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">run</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">localbuf</span> <span class="n">SOLUTION</span><span class="o">=</span><span class="mi">1</span> <span class="n">NUM_FRAMES</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>The following output is displayed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Processed</span> <span class="mf">0.02</span> <span class="n">MB</span> <span class="ow">in</span> <span class="mf">461.702</span><span class="n">s</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">MBps</span><span class="p">)</span>

<span class="n">INFO</span><span class="p">:</span> <span class="p">[</span><span class="n">Vitis</span><span class="o">-</span><span class="n">EM</span> <span class="mi">22</span><span class="p">]</span> <span class="p">[</span><span class="n">Wall</span> <span class="n">clock</span> <span class="n">time</span><span class="p">:</span> <span class="mi">20</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span> <span class="n">Emulation</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.61452</span> <span class="n">ms</span><span class="p">]</span> <span class="n">Data</span> <span class="n">transfer</span> <span class="n">between</span> <span class="n">kernel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="k">global</span> <span class="n">memory</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem1</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>              <span class="n">WR</span> <span class="o">=</span> <span class="mf">20.000</span> <span class="n">KB</span>       
<span class="n">convolve_fpga_1</span><span class="p">:</span><span class="n">m_axi_gmem2</span><span class="o">-</span><span class="n">DDR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>          <span class="n">RD</span> <span class="o">=</span> <span class="mf">0.035</span> <span class="n">KB</span>               <span class="n">WR</span> <span class="o">=</span> <span class="mf">0.000</span> <span class="n">KB</span>
</pre></div>
</div>
</div>
<div class="section" id="view-profile-summary-for-hardware-emulation">
<h2>View Profile Summary for Hardware Emulation<a class="headerlink" href="#view-profile-summary-for-hardware-emulation" title="Permalink to this heading">¶</a></h2>
<ol>
<li><p>Use the following command to view the Profile Summary report.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">view_run_summary</span> <span class="n">TARGET</span><span class="o">=</span><span class="n">hw_emu</span> <span class="n">STEP</span><span class="o">=</span><span class="n">localbuf</span>
</pre></div>
</div>
<p>The kernel execution time is now 1.574 ms rather than the baseline performance of 3.903 ms (see the following table). This is because you removed all global memory accesses for the calculation and stored image data and coefficients in the local memory.</p>
</li>
<li><p>Capture the performance data from Profile Summary report, and add it to the following table.</p></li>
</ol>
<p>Here is the updated table. There is a 2.48x boost on kernel execution time perspective.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th align="left">Step</th>
<th align="left">Image Size</th>
<th align="right">Time (HW-EM)(ms)</th>
<th align="right">Reads (KB)</th>
<th align="right">Writes (KB)</th>
<th align="right">Avg. Read (KB)</th>
<th align="right">Avg. Write (KB)</th>
<th align="right">BW (MBps)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">baseline</td>
<td align="left">512x10</td>
<td align="right">3.903</td>
<td align="right">344</td>
<td align="right">20.0</td>
<td align="right">0.004</td>
<td align="right">0.004</td>
<td align="right">5.2</td>
</tr>
<tr>
<td align="left">localbuf</td>
<td align="left">512x10</td>
<td align="right">1.574 (2.48x)</td>
<td align="right">21  (0.12x)</td>
<td align="right">20.0</td>
<td align="right">0.064</td>
<td align="right">0.064</td>
<td align="right">13</td>
</tr>
</tbody>
</table></div>
<div class="section" id="next-step">
<h2>Next Step<a class="headerlink" href="#next-step" title="Permalink to this heading">¶</a></h2>
<p>You will now look at optimizing floating point calculations for an FPGA by <a class="reference internal" href="fixedtype.html"><span class="doc">optimizing using fixed point datatypes</span></a>.
</br></p>
<hr/>
<p align="center" class="sphinxhide"><b><a href="/docs/vitis-getting-started/README.md">Return to Getting Started Pathway</a> — <a href="/docs/convolution-tutorial/README.md">Return to Start of Tutorial</a></b></p><p align="center" class="sphinxhide"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>
</div>


           </div>
          </div>
          
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
				  
				  <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Xilinx, Inc. Xilinx is now a part of AMD.
      <span class="lastupdated">Last updated on May 16, 2022.
      </span></p>
  </div>



										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">

													                    <div class="row">
                        <div class="col-xs-24">
                          <p><a target="_blank" href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a> | <a target="_blank" href="https://www.amd.com/en/corporate/privacy">Privacy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a> | <a target="_blank" href="https://www.amd.com/en/corporate/trademarks">Trademarks</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a> | <a target="_blank" href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a> | <a target="_blank" href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a> | <a target="_blank" href="https://docs.xilinx.com/v/u/9x6YvZKuWyhJId7y7RQQKA">Inclusive Terminology</a> | <a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></p>
                        </div>
                    </div>
												</div>
											</div>
										</div>
										
</br>


  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>