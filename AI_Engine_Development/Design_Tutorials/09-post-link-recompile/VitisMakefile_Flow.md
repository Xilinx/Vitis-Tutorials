<table>
 <tr>
   <td align="center"><img src="https://raw.githubusercontent.com/Xilinx/Image-Collateral/main/xilinx-logo.png" width="30%"/><h1>Post-Link Recompile of an AI Engine Application</h1>
   </td>
 </tr>
 <tr>
 <td align="center"><h1>Vitis Makefile Flow</h1>
 </td>
 </tr>

</table>


# Phase 1: Creating a Fixed Platform from an AI Engine Application and PL Kernels

This lab uses the same files as in the [Vitis IDE flow](VitisIDE_Flow.md), but all the operations are completed within a terminal.

1. To complete phase 1, change directory: `cd Phase1`.

   This directory contains a single file, which is a Makefile. Open it in any editor or display it in the terminal using `more`, `less`, or `cat`. The Makefile contains three stages:

   * `kernels`: To build the PL kernels. The output is a number of XO files, which are packaged RTL kernels.

   * `aie`: To build the AI Engine graph. The output is the file `libadf.a`, which is the compiled graph with all the PL/AI Engine interfaces.

   * `xclbin`: To link the AI Engine array design with the PL design. This stage creates the XCLBIN and the XSA files.

   There is also an optional stage to simulate the AI Engine application using the `aiesim` target.

   The following directories specified for the application files should work as they are provided with this tutorial:

    ```
    AIE:= ../Files/AIE
    PL:=../Files/PL
    HwLink:=../Files/HwLink
    ```

2. For the platform directory, if `$PLATFORM_REPO_PATHS` is known in the terminal and it contains the platform **xilinx_vck190_base_202120_1**, use it. If this environment variable is not known, use your own platform directory.

3. In the terminal, type `make clean all` and all the required stages (`kernels`, `aie`, and `xclbin`) will be run in the terminal. When the run completes, check that the XSA and the XCLBIN files are in the `Phase1` directory.

4. Check the placement of the AI Engine kernels using Vitis Analyzer and opening the `aiecompile.summary` file.


# Phase 2: Using a Platform Generated by Vitis and Modifying the AI Engine Application

In phase 2, there are five stages:


 * **pfm**: Creates a fixed platform with the AI Engine and PS domains. The PS domain is a Linux-based OS that uses XRT to control the PL and the AI Engine kernels.

 * **aie**: As in the previous phase, this stage builds an AI Engine application, but in this case it will use the new platform constraints.

 * **host**: Compiles the PS application.

 * **package**: Creates the PDI to load onto the device (`hw_emu`).

 * **run_emu**: Launches the simulation and verifies that the output is still correct.


5. Ensure that all the directory references exist in the Makefile.

```
ROOTFS  := ${LOCAL}/common/xilinx-versal-common-v2021.2/rootfs.ext4
NEW_ROOTFS := $(ROOTFS)
XRT_IMAGE   := ${LOCAL}/platforms/xilinx_vck190_base_202120_1/sw/xilinx_vck190_base_202120_1/xrt/image
NEW_IMAGE   := ${LOCAL}/common/xilinx-versal-common-v2021.2/Image
SYSROOT := ${LOCAL}/petalinux/2021.2/sysroots
BIF := ${LOCAL}/platforms/xilinx_vck190_base_202120_1/sw/xilinx_vck190_base_202120_1/boot/linux.bif
BOOT := ${LOCAL}/platforms/xilinx_vck190_base_202120_1/sw/xilinx_vck190_base_202120_1/boot
QEMU := ${LOCAL}/platforms/xilinx_vck190_base_202120_1/sw/xilinx_vck190_base_202120_1/qemu
```

6. Typically, the `${LOCAL}` directory contains three sub-directories: `platforms`, `common`, and `petalinux`. If this is not the case in your install, make the necessary edits in the Makefile.

   The first stage, `make pfm`, takes longer because there are directory copies to perform. All the operations are handled by a Tcl file: `xsct_create_pfm.tcl`.

   The second stage, `make aie`, consists of generating the AI Engine application graph. The kernel itself has changed (this is the scalar version of the previous kernel) as well as the graph. A core location constraint has been added so that you can see a big difference in the kernel placement. Check this new placement using Vitis Analyzer on the compile summary.

   The third stage, `make host`, is straightforward and you can see that the first object file that is created is `aie_control_xrt.o`. It is built from the CPP file that has been generated by the second stage.

   The fourth stage, `make package`, has a number of outputs. Among them is a file named `launch_hw_emu.sh`, which is used to run the hardware emulation in the last stage.

   The fifth and final stage, `make run_emu`, starts the hardware emulation.

   **Note:** The simulation does not launch automatically. You have to launch it manually.

   The following is the last message in the terminal:

    ```
  root@versal-rootfs-common-2021_2:~# xinit: giving up
  xinit: unable to connect to X server: Connection refused
  xinit: server error
  Enabling notebook extension jupyter-js-widgets/extension...
        - Validating: OK
  [C 14:24:50.448 NotebookApp] Bad config encountered during initialization:
  [C 14:24:50.452 NotebookApp] No such notebook dir: ''/usr/share/example-notebooks''
  ```


7. To launch the simulation, type:

```
cd /mnt/sd-mmcblk0p1
source ./init.sh
./host.exe a.xclbin
```

---

# Phase 3: Perform on-board interesting

1. To perform on-board testing, the same stages can be replicated but with a different target:

- **Phase 1**: type `make TARGET=hw all`
- **Phase 2**: type `make TARGET=hw all`

2. When the phase 2 process is finished, an `sd_card.img` file has been created and can be used as in the **Vitis IDE** flow.

3. To lauch the program on the board, type:

```
cd /mnt/sd-mmcblk0p1
source ./init.sh
./host.exe a.xclbin
```



---

&copy; Copyright 2021 Xilinx, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

```
    http://www.apache.org/licenses/LICENSE-2.0
```

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.


<p align="center"><sup>Copyright&copy; 2021 Xilinx</sup><br><sup>XD039</sup></br></p>
